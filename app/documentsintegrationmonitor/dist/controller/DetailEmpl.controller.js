sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","../model/formatter","sap/m/library","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/Fragment","sap/ui/model/Sorter","sap/ui/Device"],function(e,t,s,i,r,a,o,n,l){"use strict";var g=i.URLHelper;var u;return e.extend("shapein.DocumentsIntegrationMonitor.controller.DetailEmpl",{formatter:s,onInit:function(){var e=new t({busy:false,delay:0,lineItemListTitle:this.getResourceBundle().getText("detailLineItemTableHeading")});var s=new t({oCounterAll:"",oCounterSuccess:"",oCounterError:""});this.getView().setModel(s,"counters");this.getRouter().getRoute("objectempl").attachPatternMatched(this._onObjectMatched,this);this.setModel(e,"detailView");this.setModel(new t,"data");this.setModel(new t,"message");this.getOwnerComponent().getModel().metadataLoaded().then(this._onMetadataLoaded.bind(this));this._oTableFilterState={aFilter:[],aSearch:[]};var i=new sap.m.MessageItem({type:"{message>type}",title:"{message>title}",activeTitle:"{message>active}",description:"{message>description}",subtitle:"{message>subtitle}",counter:"{message>counter}"});u=new sap.m.MessagePopover({items:{path:"message>/",template:i},activeTitlePress:function(){}});this.getView().addDependent(u)},onSendEmailPress:function(){var e=this.getModel("detailView");g.triggerEmail(null,e.getProperty("/shareSendEmailSubject"),e.getProperty("/shareSendEmailMessage"))},onListUpdateFinished:function(e){var t,s=e.getParameter("total"),i=this.getModel("detailView");if(this.byId("lineItemsList").getBinding("items").isLengthFinal()){if(s){t=this.getResourceBundle().getText("detailLineItemTableHeadingCount",[s])}else{t=this.getResourceBundle().getText("detailLineItemTableHeading")}i.setProperty("/lineItemListTitle",t)}},_onObjectMatched:function(e){var t=e.getParameter("arguments").objectId;this.getModel("appView").setProperty("/layout","TwoColumnsMidExpanded");this.getModel().metadataLoaded().then(function(){var e=this.getModel().createKey("Di_Employee",{uuid:t});this._bindView("/"+e)}.bind(this))},_bindView:function(e){var t=this.getModel("detailView");t.setProperty("/busy",true);this.getView().bindElement({path:e,events:{change:this._onBindingChange.bind(this),dataRequested:function(){t.setProperty("/busy",true)},dataReceived:function(){t.setProperty("/busy",false)}}})},_onBindingChange:function(){var e=this.getView(),t=e.getElementBinding();if(!t.getBoundContext()){this.getRouter().getTargets().display("detailObjectNotFound");this.getOwnerComponent().oListSelector.clearMasterListSelection();return}var s=t.getPath(),i=this.getResourceBundle(),r=e.getModel().getObject(s),a=r.id,o=r.reference_id,n=this.getModel("detailView");var l=this.getOwnerComponent().getModel();var g=this.getView().getModel("items");var u=this;n.refresh();l.read(s,{urlParameters:{$expand:"emp_template/template,worker"},success:function(e,t){var s=e.emp_template.results;var i=0;var r=0;u.reprocesses=[];n.setProperty("/busy",false);e.docs=s;g.setData(e);n.setProperty("/busy",false);if(u.reprocesses.length>0){u.getView().byId("reproc").setVisible(true)}else{u.getView().byId("reproc").setVisible(false)}u.getView().byId("tabfSuc").setCount(i);u.getView().byId("tabfErr").setCount(r);u.getCounters()},error:function(e){n.setProperty("/busy",false)}});this.getOwnerComponent().oListSelector.selectAListItem(s);n.setProperty("/saveAsTileTitle",i.getText("shareSaveTileAppTitle",[o]));n.setProperty("/shareOnJamTitle",o);n.setProperty("/shareSendEmailSubject",i.getText("shareSendEmailObjectSubject",[a]));n.setProperty("/shareSendEmailMessage",i.getText("shareSendEmailObjectMessage",[o,a,location.href]))},_onMetadataLoaded:function(){var e=this.getView().getBusyIndicatorDelay(),t=this.getModel("detailView"),s=this.byId("lineItemsList"),i=s.getBusyIndicatorDelay();t.setProperty("/delay",0);t.setProperty("/lineItemTableDelay",0);s.attachEventOnce("updateFinished",function(){t.setProperty("/lineItemTableDelay",i)});t.setProperty("/busy",true);t.setProperty("/delay",e)},onCloseDetailPress:function(){this.getModel("appView").setProperty("/actionButtonsInfo/midColumn/fullScreen",false);this.getOwnerComponent().oListSelector.clearMasterListSelection();this.getRouter().navTo("master")},toggleFullScreen:function(){var e=this.getModel("appView").getProperty("/actionButtonsInfo/midColumn/fullScreen");this.getModel("appView").setProperty("/actionButtonsInfo/midColumn/fullScreen",!e);if(!e){this.getModel("appView").setProperty("/previousLayout",this.getModel("appView").getProperty("/layout"));this.getModel("appView").setProperty("/layout","MidColumnFullScreen")}else{this.getModel("appView").setProperty("/layout",this.getModel("appView").getProperty("/previousLayout"))}},b64DecodeUnicode:function(e){if(e==null||!e||e==undefined){return""}else{return decodeURIComponent(atob(e).split("").map(function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)}).join(""))}},pressError:function(e){var t=e.getSource().getBindingContext().getPath();var s=this.getView().getModel();var i=t+"/message/text";var r=t+"/error_message";var a=s.getProperty(i);var o=this.b64DecodeUnicode(s.getProperty(r));var n=o.replace("{","(");var l=n.replace("}",")");var g=new sap.m.Dialog({contentWidth:"500px",contentHeight:"auto",title:"Error Message",type:"Message",state:"Error",content:new sap.ui.layout.VerticalLayout({class:"sapUiContentPadding",width:"100%",content:[new sap.m.Text({class:"sapUiSmallMarginBottom",wrapping:true,text:a}),new sap.m.Label({class:"sapUiSmallMarginTop",text:""}),new sap.m.Label({class:"sapUiSmallMarginTop",text:"Technical Error:"}),new sap.m.Text({wrapping:true,text:l})]}),endButton:new sap.m.Button({text:"Close",press:function(){g.close()}}),afterClose:function(){g.destroy()}});g.open()},onActionRepro:function(e){var t="Are you sure you want to reprocess Employee in this Integration Process?";var s=this;var i=new sap.m.Dialog({title:"Confirmation",type:"Message",content:new sap.m.Text({text:t}),beginButton:new sap.m.Button({text:"Yes",press:function(){var e=new Date;var t=new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds()));var r=JSON.parse(JSON.stringify(t));r=r.slice(0,-5);var a={test_mode:"False",reprocess:"True",transaction_log:{time_zone:"UTC",effective_from:"1900-01-01T00:00:01",effective_to:r},workers:{reference_id:"WID",workers_list:s.reprocesses}};var o=s.getModel("detailView");var n=JSON.stringify(a);var l="/CPI-WD2PD_Dest/di/templates/template/reprocessingÂ ";var g=s.getOwnerComponent().settings.find(e=>e.code==="Customer-Code");var u=s.getOwnerComponent().settings.find(e=>e.code==="Customer-Client_Id");var p=s.getOwnerComponent().settings.find(e=>e.code==="Customer-Scope");var d={url:l,method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","Customer-Code":g.value,"Customer-Client_Id":u.value,"Customer-Scope":p.value},data:n};$.ajax(d).done(function(e,t,i){var r=e;var a=t;var o=i;if(t=="success"){s.getView().byId("reproc").setVisible(false);var n="All Workers reprocessed.";sap.m.MessageToast.show(n)}}).fail(function(e,t,s){var i=e;var r=t;var a=s});i.close()}}),endButton:new sap.m.Button({text:"No",press:function(){i.close()}}),afterClose:function(){i.destroy()}});i.open()},onActionRepro2:function(e){var t=this.getView().getModel("items");var s="/template_uuid";var i=t.getProperty(s);var r={template_uuid:i,employees:[]};var a=t.getProperty("/docs");var o="Are you sure you want to reprocess Employee in this Integration Process?";var n=this;var l=new sap.m.Dialog({title:"Confirmation",type:"Message",content:new sap.m.Text({text:o}),beginButton:new sap.m.Button({text:"Yes",press:function(){a.forEach(function(e){var t=e.employee_number;var s=e.tlog_timezone;var i=e.tlog_updated_from;var a=e.tlog_retro_effective_from;var o=e.tlog_future_updated_from;var n=new Date(i);i=new Date(Date.UTC(n.getUTCFullYear(),n.getUTCMonth(),n.getUTCDate(),n.getUTCHours(),n.getUTCMinutes(),n.getUTCSeconds()));i=JSON.parse(JSON.stringify(i));var n=new Date(a);a=new Date(Date.UTC(n.getUTCFullYear(),n.getUTCMonth(),n.getUTCDate(),n.getUTCHours(),n.getUTCMinutes(),n.getUTCSeconds()));a=JSON.parse(JSON.stringify(a));var n=new Date(o);o=new Date(Date.UTC(n.getUTCFullYear(),n.getUTCMonth(),n.getUTCDate(),n.getUTCHours(),n.getUTCMinutes(),n.getUTCSeconds()));o=JSON.parse(JSON.stringify(o));var l={employee_number:t,tlog_timezone:s,tlog_updated_from:i,tlog_retro_effective_from:a,tlog_future_updated_from:o};r.employees.push(l)});var e=n.getModel("detailView");var t=JSON.stringify(r);var s="/CPI-WD2PD_Dest/di/templates/template/reprocessing";var i={url:s,method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},data:t};$.ajax(i).done(function(e,t,s){if(t=="success"){n.getView().byId("reproc").setVisible(false);var i="All Employees reprocessed.";sap.m.MessageToast.show(i);var r=n.getView().byId("lineItemsList").getItems();r.forEach(function(e){e.getCells()[6].setEnabled(false)})}}).fail(function(e,t,s){var i=e;var r=t;var a=s;sap.m.MessageToast.show("An error occurred during the update task.")});l.close()}}),endButton:new sap.m.Button({text:"No",press:function(){l.close()}}),afterClose:function(){l.destroy()}});l.open()},onAction:function(e){var t=e.getSource().getParent().getBindingContext("items").getPath();var s=this.getView().getModel("items");var i=t+"/employee_number";var r=s.getProperty(i);var a="/template_uuid";var o=s.getProperty(a);var n=t+"/tlog_timezone";var l=s.getProperty(n);var g=t+"/tlog_updated_from";var u=s.getProperty(g);var p=t+"/tlog_retro_effective_from";var d=s.getProperty(p);var c=t+"/tlog_future_updated_from";var m=s.getProperty(c);var h=this;var v="Are you sure you want to reprocess Employee ";v=v+r+"?";var f=new sap.m.Dialog({title:"Confirmation",type:"Message",content:new sap.m.Text({text:v}),beginButton:new sap.m.Button({text:"Yes",press:function(){var e=new Date(u);u=new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds()));u=JSON.parse(JSON.stringify(u));var e=new Date(d);d=new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds()));d=JSON.parse(JSON.stringify(d));var e=new Date(m);m=new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds()));m=JSON.parse(JSON.stringify(m));var i={template_uuid:o,employees:[{employee_number:r,tlog_timezone:l,tlog_updated_from:u,tlog_retro_effective_from:d,tlog_future_updated_from:m}]};var a=h.getModel("detailView");var n=JSON.stringify(i);var g="/CPI-WD2PD_Dest/di/templates/template/reprocessing";var p={url:g,method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},data:n};$.ajax(p).done(function(e,i,a){var o=e;var n=i;var l=a;if(i=="success"){var g=t+"/action";s.setProperty(g,"");s.refresh();var u="Employee "+r+" reprocessed.";sap.m.MessageToast.show(u);h.getView().byId("reproc_ind").setEnable(false)}}).fail(function(e,t,s){var i=e;var r=t;var a=s;sap.m.MessageToast.show("An error occurred during the update task.")});f.close()}}),endButton:new sap.m.Button({text:"No",press:function(){f.close()}}),afterClose:function(){f.destroy()}});f.open()},handleMessagePopoverPress:function(e){var t=e.getSource().getParent().getBindingContext("items").getPath();var s=this.getView().getModel("items");var i="/timestamp_start";var r=t+"/error_code";var a=t+"/message/text";var o=t+"/error_message";var n=s.getProperty(i);var l=sap.ui.core.format.DateFormat.getDateInstance({pattern:"YYYY-MM-dd HH:mm:ss"});var g=l.format(n);var p=s.getProperty(r);var d=s.getProperty(a);var c=this.b64DecodeUnicode(s.getProperty(o));var m=[{type:"Information",title:"Timestamp:",description:"",subtitle:g},{type:"Error",title:"Error Code",subtitle:p,description:""},{type:"Error",title:"Error Text",description:d},{type:"Error",title:"Error Message",description:c}];var h=this.getView().getModel("message");h.setData(m);u.toggle(e.getSource())},searchFilters:function(){var e=[],t=[],s=[];if(this.byId("viewSettingsDialogDetailEmpl")){e=this.byId("viewSettingsDialogDetailEmpl").getFilterItems();var i=this.byId("viewSettingsDialogDetailEmpl").getFilterItems()[0].getCustomControl();var o=i.getContent()[1].getValue();var n=i.getContent()[3].getValue();this.fromLastPreviousValue=o;this.toLastPreviousValue=n;if(o!==""&&n==""){t.push(new r([new r(e[0].getKey(),a.GE,o)],true))}else if(o==""&&n!==""){t.push(new r([new r(e[0].getKey(),a.LE,n)],true))}else if(o!==""&&n!==""){t.push(new r([new r(e[0].getKey(),a.BT,o,n)],true))}var l=this.byId("viewSettingsDialogDetailEmpl").getFilterItems()[1].getCustomControl();var o=l.getContent()[1].getValue();var n=l.getContent()[3].getValue();this.fromLastPreviousValue=o;this.toLastPreviousValue=n;if(o!==""&&n==""){t.push(new r([new r(e[1].getKey(),a.GE,o)],true))}else if(o==""&&n!==""){t.push(new r([new r(e[1].getKey(),a.LE,n)],true))}else if(o!==""&&n!==""){t.push(new r([new r(e[1].getKey(),a.BT,o,n)],true))}var g=this.byId("viewSettingsDialogDetailEmpl").getFilterItems()[2].getCustomControl();var o=g.getContent()[1].getValue();var n=g.getContent()[3].getValue();this.fromLastPreviousValue=o;this.toLastPreviousValue=n;if(o!==""&&n==""){t.push(new r([new r(e[2].getKey(),a.GE,o)],true))}else if(o==""&&n!==""){t.push(new r([new r(e[2].getKey(),a.LE,n)],true))}else if(o!==""&&n!==""){t.push(new r([new r(e[2].getKey(),a.BT,o,n)],true))}var u=this.byId("viewSettingsDialogDetailEmpl").getSortItems();var p;u.forEach(function(e){if(e.getSelected()){p=e}});var d=this.byId("viewSettingsDialogDetailEmpl").getSortDescending()}var c=this.getView().byId("iconTab").getSelectedKey();if(c=="Suc"){t.push(new r("status",a.EQ,"S"))}else if(c=="Err"){t.push(new r("status",a.EQ,"E"))}var m=this.getView().byId("search").getValue();if(m!==""){t.push(new r([new r("template/template_id",a.Contains,m),new r("template/doc_title",a.Contains,m),new r("template/description",a.Contains,m)],false))}this._oTableFilterState.aFilter=t;this._applyFilterSearch();if(this.byId("viewSettingsDialogDetailEmpl")){this._applySortGroup(p,d)}},_applyFilterSearch:function(){var e=this._oTableFilterState.aSearch.concat(this._oTableFilterState.aFilter);this.getView().byId("lineItemsList").getBinding("items").filter(e,"Application")},onShareInJamPress:function(){var e=this.getModel("detailView"),t=sap.ui.getCore().createComponent({name:"sap.collaboration.components.fiori.sharing.dialog",settings:{object:{id:location.href,share:e.getProperty("/shareOnJamTitle")}}});t.open()},onListUpdateFinished:function(e){var t,s=e.getParameter("total"),i=this.getModel("detailView");if(this.byId("lineItemsList").getBinding("items").isLengthFinal()){if(s){t=this.getResourceBundle().getText("detailLineItemTableHeadingCount",[s])}else{t=this.getResourceBundle().getText("detailLineItemTableHeading")}i.setProperty("/lineItemListTitle",t)}},onFilterSelect:function(e){var t=this.getView().byId("lineItemsList").getBinding("items"),s=e.getParameter("key"),i=[];if(s==="Ok"){}else if(s==="Suc"){var a=new r("status_code","EQ","S");i.push(new r([a],true))}else if(s==="Err"){var o=new r("status_code","EQ","E");i.push(new r([o],true))}t.filter(i)},handleCancel:function(){var e=this.byId("viewSettingsDialogDetailEmpl").getFilterItems()[0].getCustomControl();var t=this.byId("viewSettingsDialogDetailEmpl").getFilterItems()[0],s=e.getContent()[1],i=e.getContent()[3];s.setValue(this.fromWorkerPreviousValue);i.setValue(this.toWorkerPreviousValue);if(this.fromWorkerPreviousValue!==""||this.toWorkerPreviousValue!==""){t.setFilterCount(1);t.setSelected(true)}else{t.setFilterCount(0);t.setSelected(false)}var r=this.byId("viewSettingsDialogDetailEmpl").getFilterItems()[1].getCustomControl();var a=this.byId("viewSettingsDialogDetailEmpl").getFilterItems()[1],o=r.getContent()[1],n=r.getContent()[3];o.setValue(this.fromLastPreviousValue);n.setValue(this.toLastPreviousValue);if(this.fromLastPreviousValue!==""||this.toLastPreviousValue!==""){a.setFilterCount(1);a.setSelected(true)}else{a.setFilterCount(0);a.setSelected(false)}},handleResetFilters:function(){var e=this.byId("viewSettingsDialogDetailEmpl").getFilterItems()[0].getCustomControl();var t=this.byId("viewSettingsDialogDetailEmpl").getFilterItems()[0],s=e.getContent()[1],i=e.getContent()[3];s.setValue("");i.setValue("");t.setFilterCount(0);t.setSelected(false);var r=this.byId("viewSettingsDialogDetailEmpl").getFilterItems()[1].getCustomControl();var a=this.byId("viewSettingsDialogDetailEmpl").getFilterItems()[1],o=r.getContent()[1],n=r.getContent()[3];o.setValue("");n.setValue("");a.setFilterCount(0);a.setSelected(false)},onOpenViewSettings:function(e){var t="filter";if(e.getSource()instanceof sap.m.Button){var s=e.getSource().getId();if(s.match("sort")){t="sort"}else if(s.match("group")){t="group"}}if(!this.byId("viewSettingsDialogDetailEmpl")){o.load({id:this.getView().getId(),name:"shapein.DocumentsIntegrationMonitor.view.ViewSettingsDialogDetailEmpl",controller:this}).then(function(e){this.getView().addDependent(e);e.addStyleClass(this.getOwnerComponent().getContentDensityClass());e.open(t)}.bind(this))}else{this.byId("viewSettingsDialogDetailEmpl").open(t)}},_applySortGroup:function(e,t){var s,i,r=[];s=e.getKey();i=t;r.push(new n(s,i));var a=this.getView().byId("lineItemsList").getBinding("items");a.sort(r)},_applySortGroup1:function(e){var t=e.getParameters(),s,i,r=[];s=t.sortItem.getKey();i=t.sortDescending;r.push(new n(s,i));var a=this.getView().byId("lineItemsList").getBinding("items");a.sort(r)},onSelectionChangeEmplDet:function(e){var t=e.getSource(),s=e.getParameter("selected");if(!(t.getMode()==="MultiSelect"&&!s)){this._showDetailEmplDet(e.getParameter("listItem")||e.getSource())}},_showDetailEmplDet:function(e){var t=!l.system.phone;this.getModel("appView").setProperty("/layout","TwoColumnsMidExpanded");this.getRouter().navTo("detailEmplDetail",{employee:e.mAggregations.cells[5].getProperty("text"),template:e.mAggregations.cells[6].getProperty("text")},t)},getCounters:function(){var e;var t;var s=0;var i=0;var r=0;e=this.getView().byId("lineItemsList");t=e.getBinding("items");s=t.getContexts().length;t.oList.forEach(function(e){if(e.last_status=="S"){i=i+1}else{r=r+1}});var a=this.getView().getModel("counters");a.oData.oCounterAll=s;a.oData.oCounterSuccess=i;a.oData.oCounterError=r;this.getView().setModel(a,"counters");this.getView().byId("tabfAll").setCount(s);this.getView().byId("tabfSuc").setCount(i);this.getView().byId("tabfErr").setCount(r)}})});