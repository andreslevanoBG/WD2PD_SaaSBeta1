sap.ui.define(["sap/ui/model/json/JSONModel","sap/ui/core/mvc/Controller","./BaseController","../model/formatter","sap/m/library","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/Fragment","sap/ui/model/Sorter","sap/ui/Device"],function(e,t,r,a,i,o,s,n,l,u){"use strict";var g=i.URLHelper;var p;return r.extend("shapein.DocumentsIntegrationMonitor.controller.DetailEmplDetail",{formatter:a,onInit:function(){var t=new e({template_uuid:"",employee_uuid:"",employee_number:"",template_id:"",doc_title:"",doc_type_id:"",language:"",template_version:""});this.getView().setModel(t,"parameters");var r=new e({busy:false,delay:0,lineItemListTitle:this.getResourceBundle().getText("detailDetailLineItemTableHeading")});this.getRouter().getRoute("detailEmplDetail").attachPatternMatched(this._onObjectMatched,this);this.setModel(r,"detailDetailView");this.getOwnerComponent().getModel().metadataLoaded().then(this._onMetadataLoaded.bind(this));this._oTableFilterState={aFilter:[],aSearch:[]}},onSendEmailPress:function(){var e=this.getModel("detailDetailView");g.triggerEmail(null,e.getProperty("/shareSendEmailSubject"),e.getProperty("/shareSendEmailMessage"))},onListUpdateFinished:function(e){var t,r=e.getParameter("total"),a=this.getModel("detailDetailView");if(this.byId("lineItemsListEmpl").getBinding("itemsEmpl").isLengthFinal()){if(r){t=this.getResourceBundle().getText("detailLineItemTableHeadingCount",[r])}else{t=this.getResourceBundle().getText("detailLineItemTableHeading")}a.setProperty("/lineItemListTitle",t)}},_onObjectMatched:function(e){var t=e.getParameter("arguments").subObjectId;var r=e.getParameter("arguments").employee;var a=e.getParameter("arguments").template;this.getModel().metadataLoaded().then(function(){var e=this.getModel("parameters");e.oData.employee_uuid=r;e.oData.template_uuid=a;this.setModel(e,"parameters");var t="Di_Generation_Processes_Doc";this._bindView("/"+t)}.bind(this))},_bindView:function(e){var t=this.getModel("detailDetailView");t.setProperty("/busy",false);this.getView().bindElement({path:e,events:{change:this._onBindingChange.bind(this),dataRequested:function(){t.setProperty("/busy",true)},dataReceived:function(){t.setProperty("/busy",false)}}})},_onBindingChange:function(){var e=this.getView(),t=e.getElementBinding();var r=t.getPath(),a=this.getModel("detailDetailView");var i=this.getOwnerComponent().getModel();var n=this.getView().getModel("itemsEmpl");var l=this;var u=this.getView().getModel("parameters");var g=this.getModel("parameters");var p=new o({filters:[new o("generation_proc/template_uuid",s.EQ,g.oData.template_uuid),new o("employee_external_id",s.EQ,g.oData.employee_uuid)],and:true});a.refresh();i.read(r,{filters:[p],urlParameters:{$expand:"generation_proc,message,doc_sign,last_temp_employee,worker"},success:function(e,t){var r=e.results;var i=0;var o=0;l.reprocesses=[];a.setProperty("/busy",false);var s=u.getData();s.template_id=e.results[0].generation_proc.template_id;s.doc_type_id=e.results[0].generation_proc.doc_type_id;s.template_version=e.results[0].generation_proc.template_version;u.setData(s);e.docs=r;n.setData(e);a.setProperty("/busy",false);if(l.reprocesses.length>0){l.getView().byId("reproc").setVisible(true)}else{l.getView().byId("reproc").setVisible(false)}l.getView().byId("tabfSuc").setCount(i);l.getView().byId("tabfErr").setCount(o)},error:function(e){a.setProperty("/busy",false)}});this.getOwnerComponent().oListSelector.selectAListItem(r)},_onMetadataLoaded:function(){var e=this.getView().getBusyIndicatorDelay(),t=this.getModel("detailDetailView"),r=this.byId("lineItemsListEmpl"),a=r.getBusyIndicatorDelay();t.setProperty("/delay",0);t.setProperty("/lineItemTableDelay",0);r.attachEventOnce("updateFinished",function(){t.setProperty("/lineItemTableDelay",a)});t.setProperty("/busy",true);t.setProperty("/delay",e)},onCloseDetailPress:function(){var e=!u.system.phone;this.getModel("appView").setProperty("/layout","TwoColumnsMidExpanded");this.getRouter().navTo("objectempl",{objectId:oItem.getBindingContext().getProperty("uuid")},e)},toggleFullScreen:function(){var e=this.getModel("appView").getProperty("/actionButtonsInfo/midColumn/fullScreen");this.getModel("appView").setProperty("/actionButtonsInfo/midColumn/fullScreen",!e);if(!e){this.getModel("appView").setProperty("/previousLayout",this.getModel("appView").getProperty("/layout"));this.getModel("appView").setProperty("/layout","MidColumnFullScreen")}else{this.getModel("appView").setProperty("/layout",this.getModel("appView").getProperty("/previousLayout"))}},b64DecodeUnicode:function(e){if(e==null||!e||e==undefined){return""}else{return decodeURIComponent(atob(e).split("").map(function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)}).join(""))}},pressError:function(e){var t=e.getSource().getBindingContext().getPath();var r=this.getView().getModel();var a=t+"/message/text";var i=t+"/error_message";var o=r.getProperty(a);var s=this.b64DecodeUnicode(r.getProperty(i));var n=s.replace("{","(");var l=n.replace("}",")");var u=new sap.m.Dialog({contentWidth:"500px",contentHeight:"auto",title:"Error Message",type:"Message",state:"Error",content:new sap.ui.layout.VerticalLayout({class:"sapUiContentPadding",width:"100%",content:[new sap.m.Text({class:"sapUiSmallMarginBottom",wrapping:true,text:o}),new sap.m.Label({class:"sapUiSmallMarginTop",text:""}),new sap.m.Label({class:"sapUiSmallMarginTop",text:"Technical Error:"}),new sap.m.Text({wrapping:true,text:l})]}),endButton:new sap.m.Button({text:"Close",press:function(){u.close()}}),afterClose:function(){u.destroy()}});u.open()},onActionRepro:function(e){var t="Are you sure you want to reprocess Employee in this Integration Process?";var r=this;var a=new sap.m.Dialog({title:"Confirmation",type:"Message",content:new sap.m.Text({text:t}),beginButton:new sap.m.Button({text:"Yes",press:function(){var e=new Date;var t=new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds()));var i=JSON.parse(JSON.stringify(t));i=i.slice(0,-5);var o={test_mode:"False",reprocess:"True",transaction_log:{time_zone:"UTC",effective_from:"1900-01-01T00:00:01",effective_to:i},workers:{reference_id:"WID",workers_list:r.reprocesses}};var s=r.getModel("detailDetailView");var n=JSON.stringify(o);var l="/CPI-WD2PD_Dest/di/templates/template/reprocessingÂ ";var u=r.getOwnerComponent().settings.find(e=>e.code==="Customer-Code");var g=r.getOwnerComponent().settings.find(e=>e.code==="Customer-Client_Id");var p=r.getOwnerComponent().settings.find(e=>e.code==="Customer-Scope");var d={url:l,method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","Customer-Code":u.value,"Customer-Client_Id":g.value,"Customer-Scope":p.value},data:n};$.ajax(d).done(function(e,t,a){var i=e;var o=t;var s=a;if(t=="success"){r.getView().byId("reproc").setVisible(false);var n="All Workers reprocessed.";sap.m.MessageToast.show(n)}}).fail(function(e,t,r){var a=e;var i=t;var o=r});a.close()}}),endButton:new sap.m.Button({text:"No",press:function(){a.close()}}),afterClose:function(){a.destroy()}});a.open()},onActionRepro2:function(e){var t=this.getView().getModel("itemsEmpl");var r="/template_uuid";var a=t.getProperty(r);var i={template_uuid:a,employees:[]};var o=t.getProperty("/docs");var s="Are you sure you want to reprocess Employee in this Integration Process?";var n=this;var l=new sap.m.Dialog({title:"Confirmation",type:"Message",content:new sap.m.Text({text:s}),beginButton:new sap.m.Button({text:"Yes",press:function(){o.forEach(function(e){var t=e.employee_number;var r=e.tlog_timezone;var a=e.tlog_updated_from;var o=e.tlog_retro_effective_from;var s=e.tlog_future_updated_from;var n=new Date(a);a=new Date(Date.UTC(n.getUTCFullYear(),n.getUTCMonth(),n.getUTCDate(),n.getUTCHours(),n.getUTCMinutes(),n.getUTCSeconds()));a=JSON.parse(JSON.stringify(a));var n=new Date(o);o=new Date(Date.UTC(n.getUTCFullYear(),n.getUTCMonth(),n.getUTCDate(),n.getUTCHours(),n.getUTCMinutes(),n.getUTCSeconds()));o=JSON.parse(JSON.stringify(o));var n=new Date(s);s=new Date(Date.UTC(n.getUTCFullYear(),n.getUTCMonth(),n.getUTCDate(),n.getUTCHours(),n.getUTCMinutes(),n.getUTCSeconds()));s=JSON.parse(JSON.stringify(s));var l={employee_number:t,tlog_timezone:r,tlog_updated_from:a,tlog_retro_effective_from:o,tlog_future_updated_from:s};i.employees.push(l)});var e=n.getModel("detailDetailView");var t=JSON.stringify(i);var r="/CPI-WD2PD_Dest/di/templates/template/reprocessing";var a={url:r,method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},data:t};$.ajax(a).done(function(e,t,r){if(t=="success"){n.getView().byId("reproc").setVisible(false);var a="All Employees reprocessed.";sap.m.MessageToast.show(a);var i=n.getView().byId("lineItemsListEmpl").getItems();i.forEach(function(e){e.getCells()[6].setEnabled(false)})}}).fail(function(e,t,r){var a=e;var i=t;var o=r;sap.m.MessageToast.show("An error occurred during the update task.")});l.close()}}),endButton:new sap.m.Button({text:"No",press:function(){l.close()}}),afterClose:function(){l.destroy()}});l.open()},onAction:function(e){var t=e.getSource().getParent().getBindingContext("itemsEmpl").getPath();var r=this.getView().getModel("itemsEmpl");var a=t+"/employee_number";var i=r.getProperty(a);var o="/template_uuid";var s=r.getProperty(o);var n=t+"/tlog_timezone";var l=r.getProperty(n);var u=t+"/tlog_updated_from";var g=r.getProperty(u);var p=t+"/tlog_retro_effective_from";var d=r.getProperty(p);var m=t+"/tlog_future_updated_from";var c=r.getProperty(m);var h=this;var v="Are you sure you want to reprocess Employee ";v=v+i+"?";var f=new sap.m.Dialog({title:"Confirmation",type:"Message",content:new sap.m.Text({text:v}),beginButton:new sap.m.Button({text:"Yes",press:function(){var e=new Date(g);g=new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds()));g=JSON.parse(JSON.stringify(g));var e=new Date(d);d=new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds()));d=JSON.parse(JSON.stringify(d));var e=new Date(c);c=new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds()));c=JSON.parse(JSON.stringify(c));var a={template_uuid:s,employees:[{employee_number:i,tlog_timezone:l,tlog_updated_from:g,tlog_retro_effective_from:d,tlog_future_updated_from:c}]};var o=h.getModel("detailDetailView");var n=JSON.stringify(a);var u="/CPI-WD2PD_Dest/di/templates/template/reprocessing";var p={url:u,method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},data:n};$.ajax(p).done(function(e,a,o){var s=e;var n=a;var l=o;if(a=="success"){var u=t+"/action";r.setProperty(u,"");r.refresh();var g="Employee "+i+" reprocessed.";sap.m.MessageToast.show(g);h.getView().byId("reproc_ind").setEnable(false)}}).fail(function(e,t,r){var a=e;var i=t;var o=r;sap.m.MessageToast.show("An error occurred during the update task.")});f.close()}}),endButton:new sap.m.Button({text:"No",press:function(){f.close()}}),afterClose:function(){f.destroy()}});f.open()},handleMessagePopoverPress:function(e){var t=e.getSource().getParent().getBindingContext("itemsEmpl").getPath();var r=this.getView().getModel("itemsEmpl");var a="/timestamp_start";var i=t+"/error_code";var o=t+"/message/text";var s=t+"/error_message";var n=r.getProperty(a);var l=sap.ui.core.format.DateFormat.getDateInstance({pattern:"YYYY-MM-dd HH:mm:ss"});var u=l.format(n);var g=r.getProperty(i);var d=r.getProperty(o);var m=this.b64DecodeUnicode(r.getProperty(s));var c=[{type:"Information",title:"Timestamp:",description:"",subtitle:u},{type:"Error",title:"Error Code",subtitle:g,description:""},{type:"Error",title:"Error Text",description:d},{type:"Error",title:"Error Message",description:m}];var h=this.getView().getModel("message");h.setData(c);p.toggle(e.getSource())},searchFilters:function(){var e=[],t=[],r=[];if(this.byId("viewSettingsDialogDetailDetEmpl")){e=this.byId("viewSettingsDialogDetailDetEmpl").getFilterItems();var a=this.byId("viewSettingsDialogDetailDetEmpl").getFilterItems()[0].getCustomControl();var i=a.getContent()[1].getValue();var n=a.getContent()[3].getValue();this.fromWorkerPreviousValue=i;this.toWorkerPreviousValue=n;if(i!==""&&n==""){t.push(new o([new o("employee_number",s.GE,i)],true))}else if(i==""&&n!==""){t.push(new o([new o("employee_number",s.LE,n)],true))}else if(i!==""&&n!==""){t.push(new o([new o("employee_number",s.GE,i),new o("employee_number",s.LE,n)],true))}var l=this.byId("viewSettingsDialogDetailDetEmpl").getFilterItems()[1].getCustomControl();var u=l.getContent()[1].getValue();var g=l.getContent()[3].getValue();this.fromLastPreviousValue=u;this.toLastPreviousValue=g;if(u!==""&&g==""){t.push(new o([new o("worker/lastname",s.GE,u)],true))}else if(u==""&&g!==""){t.push(new o([new o("worker/lastname",s.LE,g)],true))}else if(u!==""&&g!==""){t.push(new o([new o("worker/lastname",s.BT,u,g)],true))}var p=this.byId("viewSettingsDialogDetailDetEmpl").getSortItems();var d;p.forEach(function(e){if(e.getSelected()){d=e}});var m=this.byId("viewSettingsDialogDetailDetEmpl").getSortDescending()}var c=this.getView().byId("iconTab").getSelectedKey();if(c=="Suc"){t.push(new o("status",s.EQ,"S"))}else if(c=="Err"){t.push(new o("status",s.EQ,"E"))}var h=this.getView().byId("search").getValue();if(h!==""){t.push(new o([new o("uuid",s.Contains,h),new o("worker/lastname",s.Contains,h)],false))}this._oTableFilterState.aFilter=t;this._applyFilterSearch();if(this.byId("viewSettingsDialogDetailDetEmpl")){this._applySortGroup(d,m)}},_applyFilterSearch:function(){var e=this._oTableFilterState.aSearch.concat(this._oTableFilterState.aFilter);this.getView().byId("lineItemsListEmpl").getBinding("items").filter(e,"Application")},onShareInJamPress:function(){var e=this.getModel("detailDetailView"),t=sap.ui.getCore().createComponent({name:"sap.collaboration.components.fiori.sharing.dialog",settings:{object:{id:location.href,share:e.getProperty("/shareOnJamTitle")}}});t.open()},onListUpdateFinished:function(e){var t,r=e.getParameter("total"),a=this.getModel("detailDetailView");if(this.byId("lineItemsListEmpl").getBinding("itemsEmpl").isLengthFinal()){if(r){t=this.getResourceBundle().getText("detailLineItemTableHeadingCount",[r])}else{t=this.getResourceBundle().getText("detailLineItemTableHeading")}a.setProperty("/lineItemListTitle",t)}},onFilterSelect:function(e){var t=this.getView().byId("lineItemsListEmpl").getBinding("itemsEmpl"),r=e.getParameter("key"),a=[];if(r==="Ok"){}else if(r==="Suc"){var i=new o("status_code","EQ","S");a.push(new o([i],true))}else if(r==="Err"){var s=new o("status_code","EQ","E");a.push(new o([s],true))}t.filter(a)},handleCancel:function(){var e=this.byId("viewSettingsDialogDetailDetEmpl").getFilterItems()[0].getCustomControl();var t=this.byId("viewSettingsDialogDetailDetEmpl").getFilterItems()[0],r=e.getContent()[1],a=e.getContent()[3];r.setValue(this.fromWorkerPreviousValue);a.setValue(this.toWorkerPreviousValue);if(this.fromWorkerPreviousValue!==""||this.toWorkerPreviousValue!==""){t.setFilterCount(1);t.setSelected(true)}else{t.setFilterCount(0);t.setSelected(false)}var i=this.byId("viewSettingsDialogDetailDetEmpl").getFilterItems()[1].getCustomControl();var o=this.byId("viewSettingsDialogDetailDetEmpl").getFilterItems()[1],s=i.getContent()[1],n=i.getContent()[3];s.setValue(this.fromLastPreviousValue);n.setValue(this.toLastPreviousValue);if(this.fromLastPreviousValue!==""||this.toLastPreviousValue!==""){o.setFilterCount(1);o.setSelected(true)}else{o.setFilterCount(0);o.setSelected(false)}},handleResetFilters:function(){var e=this.byId("viewSettingsDialogDetailDetEmpl").getFilterItems()[0].getCustomControl();var t=this.byId("viewSettingsDialogDetailDetEmpl").getFilterItems()[0],r=e.getContent()[1],a=e.getContent()[3];r.setValue("");a.setValue("");t.setFilterCount(0);t.setSelected(false);var i=this.byId("viewSettingsDialogDetailDetEmpl").getFilterItems()[1].getCustomControl();var o=this.byId("viewSettingsDialogDetailDetEmpl").getFilterItems()[1],s=i.getContent()[1],n=i.getContent()[3];s.setValue("");n.setValue("");o.setFilterCount(0);o.setSelected(false)},onOpenViewSettings:function(e){var t="filter";if(e.getSource()instanceof sap.m.Button){var r=e.getSource().getId();if(r.match("sort")){t="sort"}else if(r.match("group")){t="group"}}if(!this.byId("viewSettingsDialogDetailDetEmpl")){n.load({id:this.getView().getId(),name:"shapein.DocumentsIntegrationMonitor.view.ViewSettingsDialogDetailDetEmpl",controller:this}).then(function(e){this.getView().addDependent(e);e.addStyleClass(this.getOwnerComponent().getContentDensityClass());e.open(t)}.bind(this))}else{this.byId("viewSettingsDialogDetailDetEmpl").open(t)}},_applySortGroup:function(e,t){var r,a,i=[];r=e.getKey();if(r!=="pernr"){r="worker/"+e.getKey()}else{r="employee_number"}a=t;i.push(new l(r,a));var o=this.getView().byId("lineItemsListEmpl").getBinding("itemsEmpl");o.sort(i)},_applySortGroup1:function(e){var t=e.getParameters(),r,a,i=[];r=t.sortItem.getKey();a=t.sortDescending;i.push(new l(r,a));var o=this.getView().byId("lineItemsListEmpl").getBinding("itemsEmpl");o.sort(i)},onSelectionChangeEmplDet:function(e){var t=e.getSource(),r=e.getParameter("selected");if(!(t.getMode()==="MultiSelect"&&!r)){this._showDetailEmplDet(e.getParameter("listItem")||e.getSource())}},_showDetailEmplDet:function(e){var t=!u.system.phone;this.getRouter().navTo("detailEmplDetail",{employee:e.mAggregations.cells[1].getProperty("text"),template:e.mAggregations.cells[2].getProperty("text")},t)},handleAboutPress:function(){var e;this.oOwnerComponent.getHelper().then(function(t){e=t.getNextUIState(3);this.oRouter.navTo("page2",{layout:e.layout})}.bind(this))},_onPatternMatch:function(e){var t=e.getParameter("arguments").objectId;this._supplier=e.getParameter("arguments").supplier||this._supplier||"0";this._product=e.getParameter("arguments").product||this._product||"0";this.getView().bindElement({path:"/ProductCollectionStats/Filters/1/values/"+this._supplier,model:"products"})},handleFullScreen:function(){var e=this.oModel.getProperty("/actionButtonsInfo/endColumn/fullScreen");this.oRouter.navTo("detailDetail",{layout:e,product:this._product,supplier:this._supplier})},handleExitFullScreen:function(){var e=this.oModel.getProperty("/actionButtonsInfo/endColumn/exitFullScreen");this.oRouter.navTo("detailDetail",{layout:e,product:this._product,supplier:this._supplier})},handleClose:function(){var e=this.oModel.getProperty("/actionButtonsInfo/endColumn/closeColumn");this.oRouter.navTo("detail",{layout:e,product:this._product})},onExit:function(){this.oRouter.getRoute("detailDetail").detachPatternMatched(this._onPatternMatch,this)}})});