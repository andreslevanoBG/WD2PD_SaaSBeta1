sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","../model/formatter","sap/ui/model/Filter","sap/ui/core/Fragment","sap/ui/model/FilterOperator","./App.controller"],function(e,t,s,n,a,i,r){"use strict";return e.extend("shapein.TemplatesConfiguration.controller.Worklist",{formatter:s,onInit:function(){this.firstDisplay="X";var e,s,n=this.byId("table");s=n.getBusyIndicatorDelay();this._aTableSearchState=[];this._oTableFilterState=[];var a=this.getOwnerComponent().getRouter();var i=a.getTarget("worklist");i.attachDisplay(this.onDisplay,this);e=new t({worklistTableTitle:this.getResourceBundle().getText("worklistTableTitle"),saveAsTileTitle:this.getResourceBundle().getText("saveAsTileTitle",this.getResourceBundle().getText("worklistViewTitle")),shareOnJamTitle:this.getResourceBundle().getText("worklistTitle"),shareSendEmailSubject:this.getResourceBundle().getText("shareSendEmailWorklistSubject"),shareSendEmailMessage:this.getResourceBundle().getText("shareSendEmailWorklistMessage",[location.href]),tableNoDataText:this.getResourceBundle().getText("tableNoDataText"),tableBusyDelay:0});this.setModel(e,"worklistView");n.attachEventOnce("updateFinished",function(){e.setProperty("/tableBusyDelay",s)});this.addHistoryEntry({title:this.getResourceBundle().getText("worklistViewTitle"),icon:"sap-icon://table-view",intent:"#Worker-TemplateConfig"},true)},onUpdateFinished:function(e){var t,s=e.getSource(),n=e.getParameter("total");if(n&&s.getBinding("items").isLengthFinal()){t=this.getResourceBundle().getText("worklistTableTitleCount",[n])}else{t=this.getResourceBundle().getText("worklistTableTitle")}this.getModel("worklistView").setProperty("/worklistTableTitle",t)},onPress:function(e){this._showObject(e.getSource())},closeManageBPs:function(e){var t=e.getSource().getParent();t.close()},onDisplay:function(e){if(this.firstDisplay=="X"){this.firstDisplay=""}else{this.refresh()}},refresh:function(){var e=this.getModel("appView");var t=this.getOwnerComponent().getModel();var s=this.getOwnerComponent().getModel("templates_pers");var n=this;this.byId("table").setBusy(true);var a="/Di_Template";t.read(a,{urlParameters:{$expand:"planning"},success:function(e,t){var a=e.results;delete e.__metadata;s.setData(a);s.refresh();n.call_Templates_Pd()},error:function(e){n.byId("table").setBusy(false)}})},deleteTemplate:function(e){var t=e.getSource().getParent().getBindingContext("templates").getPath();var s=this.getView().getModel("templates");var n=t+"/uuid";var a=s.getProperty(n);var i=this;var r="Do you want to delete this Template?";var o=new sap.m.Dialog({title:"Confirmation",type:"Message",content:new sap.m.Text({text:r}),beginButton:new sap.m.Button({text:"Yes",press:function(){i.deleteTempConfirm(a);o.close()}}),endButton:new sap.m.Button({text:"No",press:function(){o.close()}}),afterClose:function(){o.destroy()}});o.open()},deleteTempConfirm:function(e){var t=this.getOwnerComponent().getModel();this.byId("table").setBusy(true);var s=this;t.callFunction("/delete_complete_template",{method:"GET",urlParameters:{uuid:e},success:function(e,t){sap.m.MessageToast.show(e.value);s.refresh();s.byId("table").setBusy(false)},error:function(e){s.byId("table").setBusy(false);sap.m.MessageToast.show("Error")}})},call_Templates_Pd:function(){var e=this.getOwnerComponent().getModel("templates_pers");var t=e.getData();var s=this.getModel("appView");var n=this.getOwnerComponent().getModel("templates");var a="/CPI-WD2PD_Dest/di/templates/templates_pd";var i=this;if(this.getOwnerComponent().settings){var r=this.getOwnerComponent().settings.find(e=>e.code==="Customer-Code");var o=this.getOwnerComponent().settings.find(e=>e.code==="Customer-Client_Id");var l=this.getOwnerComponent().settings.find(e=>e.code==="Customer-Scope");jQuery.ajax({url:a,beforeSend:function(e){e.setRequestHeader("Customer-Code",r.value);e.setRequestHeader("Customer-Client_Id",o.value);e.setRequestHeader("Customer-Scope",l.value)},type:"GET",dataType:"json",success:function(e){for(var s=0;s<e.length;s++){var a=String(e[s].active_version);var r=t.find(t=>t.template_id===e[s].id&&t.template_version===a);if(r){e[s].planned="";if(r.planning){if(r.planning.enable){e[s].planned="X"}}e[s].active=r.active;e[s].exist_pers="X";e[s].exist_PD="X";e[s].uuid=r.uuid}else{e[s].planned="";e[s].active=false;e[s].exist_pers="";e[s].exist_PD="X";e[s].uuid=""}}for(var o=0;o<t.length;o++){var a=String(t[o].template_version);var r=e.find(e=>e.id===t[o].template_id&&e.active_version==a);if(!r){var l={};l.planned="";if(t[o].planning){if(t[o].planning.enable){l.planned="X"}}l.active_version=t[o].template_version;l.active=t[o].active;l.exist_pers="X";l.description=t[o].description;l.id=t[o].template_id;l.locale=t[o].language;l.title=t[o].doc_title;l.format=t[o].format;l.updated_at=t[o].updated_at;l.exist_PD="";e.push(l)}}n.setData(e);n.refresh();i.byId("table").setBusy(false)},error:function(e){i.byId("table").setBusy(false)}})}},onSyncBP:function(e){var t=this;var s="Do you want to synchronize the Business Process Types from Workday?";var n=new sap.m.Dialog({title:"Confirmation",type:"Message",content:new sap.m.Text({text:s}),beginButton:new sap.m.Button({text:"Yes",press:function(){t.onSyncBPConfirm();n.close()}}),endButton:new sap.m.Button({text:"No",press:function(){n.close()}}),afterClose:function(){n.destroy()}});n.open()},onSyncBPConfirm:function(){var e=this;this.byId("manageBPs").setBusy(true);var t="/CPI-WD2PD_Dest/di/workday/bpt/load";if(this.getOwnerComponent().settings){var s=this.getOwnerComponent().settings.find(e=>e.code==="Customer-Code");var n=this.getOwnerComponent().settings.find(e=>e.code==="Customer-Client_Id");var a=this.getOwnerComponent().settings.find(e=>e.code==="Customer-Scope");jQuery.ajax({url:t,beforeSend:function(e){e.setRequestHeader("Customer-Code",s.value);e.setRequestHeader("Customer-Client_Id",n.value);e.setRequestHeader("Customer-Scope",a.value)},type:"GET",dataType:"json",success:function(t){e.byId("manageBPs").setBusy(false);sap.m.MessageToast.show(t.message)},error:function(t){sap.m.MessageToast.show("Workday Error: The requested resource is not available");e.byId("manageBPs").setBusy(false)}})}},onAddBP:function(e){var t=e.getSource().getId();var s="";if(!t.match("addBP")){s=e.getSource().getParent().getParent().getBindingContext("BProcess").getPath()}var n=this.getOwnerComponent().getModel();var a=this.getOwnerComponent().getModel("BProcessWD");var i=this;var r="/Di_Business_Process_Master";n.read(r,{success:function(e,n){var r=e.results;delete e.__metadata;a.setData(r);a.refresh();i.openAddBP(t,s)},error:function(e){}})},openAddBP:function(e,t){var s=this.getModel("bpt");var n=s.getData();var i="";var r=e;if(r.match("addBP")){i="New";n={retry_employee_exist:false};s.setData(n);s.refresh()}else{i="Edit";var o=this.getModel("BProcess");var l=t;var d=o.getData();var u=Object.assign({},o.getProperty(l));s.setData(u);s.refresh()}if(!this.byId("bpt")){a.load({id:this.getView().getId(),name:"shapein.TemplatesConfiguration.view.fragments.bpt",controller:this}).then(function(e){this.getView().addDependent(e);e.addStyleClass(this.getOwnerComponent().getContentDensityClass());if(i=="New"){e.setTitle("New Business Process Type");this.byId("btonAddBpt").setVisible(true);this.byId("btonEditBpt").setVisible(false);this.byId("Name_bpt").setEnabled(true)}else{e.setTitle("Edit Business Process Type");this.byId("btonEditBpt").setVisible(true);this.byId("btonAddBpt").setVisible(false);if(u.templates){if(u.templates.length>0){this.byId("Name_bpt").setEnabled(false)}else{this.byId("Name_bpt").setEnabled(true)}}else{this.byId("Name_bpt").setEnabled(true)}}e.open()}.bind(this))}else{if(i=="New"){this.byId("bpt").setTitle("New Business Process Type");this.byId("btonAddBpt").setVisible(true);this.byId("btonEditBpt").setVisible(false);this.byId("Name_bpt").setEnabled(true)}else{this.byId("bpt").setTitle("Edit Business Process Type");this.byId("btonEditBpt").setVisible(true);this.byId("btonAddBpt").setVisible(false);if(u.templates){if(u.templates.length>0){this.byId("Name_bpt").setEnabled(false)}else{this.byId("Name_bpt").setEnabled(true)}}else{this.byId("Name_bpt").setEnabled(true)}}this.byId("bpt").open()}},_validateInputNewP:function(e){var t="None";var s=false;var n=e.getValue();if(n==""){t="Error";s=true}e.setValueState(t);return s},RefBP:function(e){var t=e.getSource(),s=this.getView();var n=this.getModel("bpt");var i=this.getModel("BProcess");var r=e.getSource().getParent().getParent().getBindingContext("BProcess").getPath();var o=i.getData();var l=Object.assign({},i.getProperty(r));n.setData(l);n.refresh();if(!this._pPopover){this._pPopover=a.load({id:s.getId(),name:"shapein.TemplatesConfiguration.view.fragments.refBps",controller:this}).then(function(e){s.addDependent(e);return e})}this._pPopover.then(function(e){e.openBy(t)})},execNewBpt:function(e){var t=this.getModel("BProcess");var s=t.getData();var n=[this.byId("Desc_bpt")],a=false;n.forEach(function(e){a=this._validateInputNewP(e)||a},this);if(a){sap.m.MessageBox.alert("A validation error has occurred.");return}var i=this;var r=this.byId("Name_bpt").getSelectedKey();var o=s.find(e=>e.name===r);if(o){sap.m.MessageBox.alert("This business process type is being used.");return}var l=n[0].getValue();var d=this.byId("retry_bpt").getSelected();var u;if(!d){u=null}else{u=parseInt(this.byId("retnum_bpt").getValue())}var p={name:r,description:l,retry_employee_exist:d,retries_number:u};var c=i.getOwnerComponent().getModel();var g="Are you sure to create a new business process type?";var h=new sap.m.Dialog({title:"Confirmation",type:"Message",content:new sap.m.Text({text:g}),beginButton:new sap.m.Button({text:"Yes",press:function(){c.create("/Di_Business_Process",p,{headers:{"Content-Type":"application/json",Accept:"application/json"},success:function(e,t){i.fill_Business_Process();i.byId("bpt").close();sap.m.MessageToast.show("Business Process Type created!!")},error:function(e){sap.m.MessageToast.show("Error")}});h.close()}}),endButton:new sap.m.Button({text:"No",press:function(){h.close()}}),afterClose:function(){h.destroy()}});h.open()},execChangeBpt:function(e){var t=[this.byId("Desc_bpt")],s=false;t.forEach(function(e){s=this._validateInputNewP(e)||s},this);if(s){sap.m.MessageBox.alert("A validation error has occurred.");return}var n=this;var a=this.byId("Name_bpt").getSelectedKey();var i=t[0].getValue();var r=this.byId("retry_bpt").getSelected();var o;if(!r){o=null}else{o=parseInt(this.byId("retnum_bpt").getValue())}var l=this.getModel("bpt");var d=l.getData();var u=d.bpt_id;var p={name:a,description:i,retry_employee_exist:r,retries_number:o};var c=n.getOwnerComponent().getModel();var g="Are you sure to save this business process type?";var h="/Di_Business_Process(guid'"+u+"')";var f=new sap.m.Dialog({title:"Confirmation",type:"Message",content:new sap.m.Text({text:g}),beginButton:new sap.m.Button({text:"Yes",press:function(){c.update(h,p,{headers:{"Content-Type":"application/json",Accept:"application/json"},success:function(e,t){n.fill_Business_Process();n.byId("bpt").close();sap.m.MessageToast.show("Business Process Type saved!!")},error:function(e){sap.m.MessageToast.show("Error")}});f.close()}}),endButton:new sap.m.Button({text:"No",press:function(){f.close()}}),afterClose:function(){f.destroy()}});f.open()},cancelBpt:function(e){var t=e.getSource().getParent();t.close()},onOpenViewSettings:function(e){var t="filter";if(e.getSource()instanceof sap.m.Button){var s=e.getSource().getId();if(s.match("sort")){t="sort"}else if(s.match("group")){t="group"}}if(!this.byId("viewSettingsDialog")){a.load({id:this.getView().getId(),name:"shapein.TemplatesConfiguration.view.fragments.ViewSettingsDialog",controller:this}).then(function(e){this.getView().addDependent(e);e.addStyleClass(this.getOwnerComponent().getContentDensityClass());e.open(t)}.bind(this))}else{this.byId("viewSettingsDialog").open(t)}},onConfirmViewSettingsDialog:function(e){var t=e.getParameters().filterItems,s=[],a=[],r=[];var o;t.forEach(function(e){if(e.getKey()=="A"){o=true}else{o=false}a.push(new n(e.getParent().getKey(),i.EQ,o))});if(a.length>0){s.push(new n(a,false))}this._oTableFilterState=s;var l=this.byId("searchField").getValue();var d=[new n([new n("id",i.Contains,l),new n("title",i.Contains,l),new n("description",i.Contains,l)],false)];this._applySearch(d)},handleResetFilters:function(){},onShareInJamPress:function(){var e=this.getModel("worklistView"),t=sap.ui.getCore().createComponent({name:"sap.collaboration.components.fiori.sharing.dialog",settings:{object:{id:location.href,share:e.getProperty("/shareOnJamTitle")}}});t.open()},onBPs:function(){if(!this.byId("manageBPs")){a.load({id:this.getView().getId(),name:"shapein.TemplatesConfiguration.view.fragments.manageBPs",controller:this}).then(function(e){this.getView().addDependent(e);e.addStyleClass(this.getOwnerComponent().getContentDensityClass());e.open()}.bind(this))}else{this.byId("manageBPs").open()}},onSearch:function(e){if(e.getParameters().refreshButtonPressed){this.onRefresh()}else{var t=[];var s=e.getParameter("query");t=[new n([new n("id",i.Contains,s),new n("title",i.Contains,s),new n("description",i.Contains,s)],false)]}this._applySearch(t)},onRefresh:function(){var e=this.byId("table");e.getBinding("items").refresh()},_showObject:function(e){this.getRouter().navTo("object",{objectId:e.getBindingContext("templates").getProperty("id"),version:e.getBindingContext("templates").getProperty("active_version")})},_applySearch:function(e){var t=e.concat(this._oTableFilterState);var s=this.byId("table"),n=this.getModel("worklistView");s.getBinding("items").filter(t,"Application");if(e.length!==0){n.setProperty("/tableNoDataText",this.getResourceBundle().getText("worklistNoDataWithSearchText"))}},fill_Business_Process:function(){var e=this.getOwnerComponent().getModel();var t=this.getOwnerComponent().getModel("BProcess");var s=this;var n="/Di_Business_Process";e.read(n,{urlParameters:{$expand:"templates"},success:function(e,s){var n=e.results;delete e.__metadata;for(var a=0;a<n.length;a++){n[a].templates=n[a].templates.results}t.setData(n);t.refresh()},error:function(e){}})},deleteBP:function(e){var t=e.getSource().getParent().getParent().getBindingContext("BProcess").getPath();var s=this.getView().getModel("BProcess");var n=this.getView().getModel();var a=t+"/bpt_id";var i=s.getProperty(a);var r="/Di_Business_Process(guid'"+i+"')";var o="Are you sure to delete this Business Process Type?";var l=this;var d=new sap.m.Dialog({title:"Confirmation",type:"Message",content:new sap.m.Text({text:o}),beginButton:new sap.m.Button({text:"Yes",press:function(){n.remove(r,{success:function(e,t){l.fill_Business_Process();sap.m.MessageToast.show("Bus. Proc. Type deleted succesfully.")},error:function(e){sap.m.MessageToast.show("Error")}});d.close()}}),endButton:new sap.m.Button({text:"No",press:function(){d.close()}}),afterClose:function(){d.destroy()}});d.open()}})});