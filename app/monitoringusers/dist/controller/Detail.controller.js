sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","../model/formatter","sap/m/library","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/Fragment","sap/ui/model/Sorter"],function(e,t,i,s,a,r,n,o){"use strict";var l=s.URLHelper;var g;return e.extend("shapein.UsersMonitoring.controller.Detail",{formatter:i,fromUserPreviousValue:"",toUserPreviousValue:"",fromLastPreviousValue:"",toLastPreviousValue:"",reprocesses:[],onInit:function(){var e=new t({busy:false,delay:0,lineItemListTitle:this.getResourceBundle().getText("detailLineItemTableHeading")});this.getRouter().getRoute("object").attachPatternMatched(this._onObjectMatched,this);this.setModel(e,"detailView");this.setModel(new t,"data");this.setModel(new t,"message");this.getOwnerComponent().getModel().metadataLoaded().then(this._onMetadataLoaded.bind(this));this._oTableFilterState={aFilter:[],aSearch:[]};var i=new sap.m.MessageItem({type:"{message>type}",title:"{message>title}",activeTitle:"{message>active}",description:"{message>description}",subtitle:"{message>subtitle}",counter:"{message>counter}"});g=new sap.m.MessagePopover({items:{path:"message>/",template:i},activeTitlePress:function(){}});this.getView().addDependent(g)},onSendEmailPress:function(){var e=this.getModel("detailView");l.triggerEmail(null,e.getProperty("/shareSendEmailSubject"),e.getProperty("/shareSendEmailMessage"))},handleMessagePopoverPress:function(e){var t=e.getSource().getParent().getBindingContext("items").getPath();var i=this.getView().getModel("items");var s=t+"/timestamp_start";var a=t+"/error_code";var r=t+"/error/text";var n=t+"/error_message";var o=i.getProperty(s);var l=sap.ui.core.format.DateFormat.getDateInstance({pattern:"YYYY-MM-dd HH:mm:ss"});var u=l.format(o);var d=i.getProperty(a);var c=i.getProperty(r);var p=this.b64DecodeUnicode(i.getProperty(n));var m=[{type:"Information",title:"Timestamp:",description:"",subtitle:u},{type:"Error",title:"Error Code",subtitle:d,description:""},{type:"Error",title:"Error Text",description:c},{type:"Error",title:"Error Message",description:p}];var v=this.getView().getModel("message");v.setData(m);g.toggle(e.getSource())},onShareInJamPress:function(){var e=this.getModel("detailView"),t=sap.ui.getCore().createComponent({name:"sap.collaboration.components.fiori.sharing.dialog",settings:{object:{id:location.href,share:e.getProperty("/shareOnJamTitle")}}});t.open()},onListUpdateFinished:function(e){var t,i=e.getParameter("total"),s=this.getModel("detailView");if(this.byId("lineItemsList").getBinding("items").isLengthFinal()){if(i){t=this.getResourceBundle().getText("detailLineItemTableHeadingCount",[i])}else{t=this.getResourceBundle().getText("detailLineItemTableHeading")}s.setProperty("/lineItemListTitle",t)}},onFilterSelect:function(e){var t=this.getView().byId("lineItemsList").getBinding("items"),i=e.getParameter("key"),s=[];if(i==="Ok"){}else if(i==="Suc"){var r=new a("status_code","EQ","S");s.push(new a([r],true))}else if(i==="Err"){var n=new a("status_code","EQ","E");s.push(new a([n],true))}t.filter(s)},_onObjectMatched:function(e){var t=e.getParameter("arguments").objectId;this.getModel("appView").setProperty("/layout","TwoColumnsMidExpanded");this.getModel().metadataLoaded().then(function(){var e=this.getModel().createKey("Integrations",{id:t});this._bindView("/"+e)}.bind(this))},_bindView:function(e){var t=this.getModel("detailView");t.setProperty("/busy",true);var i=this;this.getView().bindElement({path:e,events:{change:this._onBindingChange.bind(this),dataRequested:function(){t.setProperty("/busy",true)},dataReceived:function(){t.setProperty("/busy",false)}}})},_onBindingChange:function(){var e=this.getView(),t=e.getElementBinding();if(!t.getBoundContext()){this.getRouter().getTargets().display("detailObjectNotFound");this.getOwnerComponent().oListSelector.clearMasterListSelection();return}var i=t.getPath(),s=this.getResourceBundle(),a=e.getModel().getObject(i),r=a.id,n=a.reference_id,o=this.getModel("detailView");var l=this.getOwnerComponent().getModel();var g=this.getView().getModel("items");var u=this;o.refresh();l.read(i,{urlParameters:{$expand:"integ_items/error,integ_items/user"},success:function(e,t){var i=e.integ_items.results;delete e.__metadata;var s=0;var a=0;u.reprocesses=[];i.forEach(function(e){delete e.__metadata;var t=e.user;if(t){e.pernr=t.employee_number;var i=t.firstname;var r=t.lastname;e.firstname=i;e.lastname=r;e.name=r+", "+i;e.email=e.user.email}if(e.status_code=="S"){s++}else{a++}if(e.user.last_item_id==e.item_id){e.action="X"}else{e.action=""}if(e.action=="X"&&e.status_code=="E"){u.reprocesses.push(e.original_external_id)}});e.integ_items=null;e.integ_items=i;g.setData(e);o.setProperty("/busy",false);if(u.reprocesses.length>0){u.getView().byId("reproc").setVisible(true)}else{u.getView().byId("reproc").setVisible(false)}u.getView().byId("tabfSuc").setCount(s);u.getView().byId("tabfErr").setCount(a)},error:function(e){o.setProperty("/busy",false)}});this.getOwnerComponent().oListSelector.selectAListItem(i);o.setProperty("/saveAsTileTitle",s.getText("shareSaveTileAppTitle",[n]));o.setProperty("/shareOnJamTitle",n);o.setProperty("/shareSendEmailSubject",s.getText("shareSendEmailObjectSubject",[r]));o.setProperty("/shareSendEmailMessage",s.getText("shareSendEmailObjectMessage",[n,r,location.href]))},b64DecodeUnicode:function(e){if(e==null||!e||e==undefined){return""}else{return decodeURIComponent(atob(e).split("").map(function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)}).join(""))}},onAction:function(e){var t=e.getSource().getParent().getBindingContext("items").getPath();var i=this.getView().getModel("items");var s=t+"/original_external_id";var a=t+"/user/email";var r=i.getProperty(a);var n=i.getProperty(s);var o="Are you sure you want to reprocess User ";o=o+r+"?";var l=this;var g=new sap.m.Dialog({title:"Confirmation",type:"Message",content:new sap.m.Text({text:o}),beginButton:new sap.m.Button({text:"Yes",press:function(){var e=new Date;var s=new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds()));var a=JSON.parse(JSON.stringify(s));a=a.slice(0,-5);var o={test_mode:"False",transaction_log:{time_zone:"UTC",effective_from:"1900-01-01T00:00:01",effective_to:a},workers:{reference_id:"WID",workers_list:[n]}};var u=l.getModel("detailView");var d=JSON.stringify(o);var c="/CPI-WD2PD_Dest/md/users_sync/ondemand";if(l.getOwnerComponent().settings){var p=l.getOwnerComponent().settings.find(e=>e.code==="Customer-Code");var m=l.getOwnerComponent().settings.find(e=>e.code==="Customer-Client_Id");var v=l.getOwnerComponent().settings.find(e=>e.code==="Customer-Scope");var h={url:c,method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","Customer-Code":p.value,"Customer-Client_Id":m.value,"Customer-Scope":v.value},data:d};$.ajax(h).done(function(e,s,a){var n=e;var o=s;var g=a;if(s=="success"){var u=t+"/action";i.setProperty(u,"");i.refresh();var d=i.getData().integ_items;l.reprocesses=[];for(var c=0;c<d.length;c++){if(d[c].action=="X"){l.reprocesses.push(d[c].original_external_id)}}var p="User "+r+" reprocessed.";sap.m.MessageToast.show(p)}}).fail(function(e,t,i){var s=e;var a=t;var r=i})}g.close()}}),endButton:new sap.m.Button({text:"No",press:function(){g.close()}}),afterClose:function(){g.destroy()}});g.open()},pressError:function(e){var t=e.getSource().getBindingContext().getPath();var i=this.getView().getModel();var s=t+"/error/text";var a=t+"/error_message";var r=i.getProperty(s);var n=this.b64DecodeUnicode(i.getProperty(a));var o=n.replace("{","(");var l=o.replace("}",")");var g=new sap.m.Dialog({contentWidth:"500px",contentHeight:"auto",title:"Error Message",type:"Message",state:"Error",content:new sap.ui.layout.VerticalLayout({class:"sapUiContentPadding",width:"100%",content:[new sap.m.Text({class:"sapUiSmallMarginBottom",wrapping:true,text:r}),new sap.m.Label({class:"sapUiSmallMarginTop",text:""}),new sap.m.Label({class:"sapUiSmallMarginTop",text:"Technical Error:"}),new sap.m.Text({wrapping:true,text:l})]}),endButton:new sap.m.Button({text:"Close",press:function(){g.close()}}),afterClose:function(){g.destroy()}});g.open()},onActionRepro:function(e){var t=this.getView().getModel("items");var i="Are you sure you want to reprocess Users in this Integration Process?";var s=this;var a=new sap.m.Dialog({title:"Confirmation",type:"Message",content:new sap.m.Text({text:i}),beginButton:new sap.m.Button({text:"Yes",press:function(){var e=new Date;var i=new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds()));var r=JSON.parse(JSON.stringify(i));r=r.slice(0,-5);var n={test_mode:"False",transaction_log:{time_zone:"UTC",effective_from:"1900-01-01T00:00:01",effective_to:r},workers:{reference_id:"WID",workers_list:s.reprocesses}};var o=s.getModel("detailView");var l=JSON.stringify(n);var g="/CPI-WD2PD_Dest/md/users_sync/ondemand";if(s.getOwnerComponent().settings){var u=s.getOwnerComponent().settings.find(e=>e.code==="Customer-Code");var d=s.getOwnerComponent().settings.find(e=>e.code==="Customer-Client_Id");var c=s.getOwnerComponent().settings.find(e=>e.code==="Customer-Scope");var p={url:g,method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","Customer-Code":u.value,"Customer-Client_Id":d.value,"Customer-Scope":c.value},data:l};$.ajax(p).done(function(e,i,a){var r=e;var n=i;var o=a;if(i=="success"){var l=t.getData();var g=l.integ_items;s.reprocesses=[];for(var u=0;u<g.length;u++){g[u].action=""}l.integ_items=g;t.setData(l);t.refresh();s.getView().byId("reproc").setVisible(false);var d="All Users reprocessed.";sap.m.MessageToast.show(d)}}).fail(function(e,t,i){var s=e;var a=t;var r=i})}a.close()}}),endButton:new sap.m.Button({text:"No",press:function(){a.close()}}),afterClose:function(){a.destroy()}});a.open()},onDataDialogPress:function(e){var t=this;var i=e.getSource().getParent().getBindingContext("items").getPath();var s=this.getView().getModel("items");i=i+"/request";var a=s.getProperty(i);var r=this.b64DecodeUnicode(a);var o=JSON.parse(r);var l=Object.entries(o);var g=[];var u=this.getView().getModel("data");l.forEach(function(e){var t={};if(e[0]==="registration_references"){var i=Object.entries(e[1]);i.forEach(function(e){var t={};t.Name=e[0].toString().replaceAll("_"," ");t.Value=e[1];t.key="Data";t.Icon="sap-icon://database";g.push(t)})}else if(e[0]==="custom_fields"){var s=Object.entries(e[1]);s.forEach(function(e){var t={};t.Name=e[1].code.toString().replaceAll("_"," ");t.Value=e[1].value;t.key="Data";t.Icon="sap-icon://database";g.push(t)})}else if(e[0]==="profiles"){var a=Object.entries(e[1]);a.forEach(function(e){var t={};t.Icon="sap-icon://overview-chart";t.key="Profile";t.Name=e[1].role_id.toString().replaceAll("_"," ");t.Description=e[1].employees_perimeter.operator.toString().replaceAll("_"," ");t.Value=e[1].employees_perimeter.organization_id.toString().replaceAll("_"," ");g.push(t)})}else{t.Icon="sap-icon://database";t.Name=e[0].toString().replaceAll("_"," ");t.Value=e[1];t.key="Data";g.push(t)}});u.setData(g);if(!this.oDataDialog){n.load({id:this.getView().getId(),name:"shapein.UsersMonitoring.view.DataDialog",controller:this}).then(function(e){this.oDataDialog=e;this.getView().addDependent(e);e.addStyleClass(this.getOwnerComponent().getContentDensityClass());e.open()}.bind(this))}else{this.oDataDialog.open()}},pressOkButton:function(e){this.oDataDialog.close()},getGroup:function(e){var t=e.getProperty("key");return{key:t}},getGroupHeader:function(e){return new sap.m.GroupHeaderListItem({title:e.key,upperCase:false})},onOpenViewSettings:function(e){var t="filter";if(e.getSource()instanceof sap.m.Button){var i=e.getSource().getId();if(i.match("sort")){t="sort"}else if(i.match("group")){t="group"}}if(!this.byId("viewSettingsDialogDetail")){n.load({id:this.getView().getId(),name:"shapein.UsersMonitoring.view.ViewSettingsDialogDetail",controller:this}).then(function(e){this.getView().addDependent(e);e.addStyleClass(this.getOwnerComponent().getContentDensityClass());e.open(t)}.bind(this))}else{this.byId("viewSettingsDialogDetail").open(t)}},searchFilters:function(){var e=[],t=[],i=[];if(this.byId("viewSettingsDialogDetail")){e=this.byId("viewSettingsDialogDetail").getFilterItems();var s=this.byId("viewSettingsDialogDetail").getFilterItems()[0].getCustomControl();var n=s.getContent()[1].getValue();var o=s.getContent()[3].getValue();this.fromUserPreviousValue=n;this.toUserPreviousValue=o;if(n!==""&&o==""){t.push(new a([new a("pernr",r.GE,n)],true))}else if(n==""&&o!==""){t.push(new a([new a("pernr",r.LE,o)],true))}else if(n!==""&&o!==""){t.push(new a([new a("pernr",r.GE,n),new a("pernr",r.LE,o)],true))}var l=this.byId("viewSettingsDialogDetail").getFilterItems()[1].getCustomControl();var g=l.getContent()[1].getValue();var u=l.getContent()[3].getValue();this.fromLastPreviousValue=g;this.toLastPreviousValue=u;if(g!==""&&u==""){t.push(new a([new a("lastname",r.GE,g)],true))}else if(g==""&&u!==""){t.push(new a([new a("lastname",r.LE,u)],true))}else if(g!==""&&u!==""){t.push(new a([new a("lastname",r.BT,g,u)],true))}var d=this.byId("viewSettingsDialogDetail").getSortItems();var c;d.forEach(function(e){if(e.getSelected()){c=e}});var p=this.byId("viewSettingsDialogDetail").getSortDescending()}var m=this.getView().byId("iconTab").getSelectedKey();if(m=="Suc"){t.push(new a("status_code",r.EQ,"S"))}else if(m=="Err"){t.push(new a("status_code",r.EQ,"E"))}var v=this.getView().byId("search").getValue();if(v!==""){t.push(new a([new a("name",r.Contains,v),new a("pernr",r.Contains,v)],false))}this._oTableFilterState.aFilter=t;this._applyFilterSearch();if(this.byId("viewSettingsDialogDetail")){this._applySortGroup(c,p)}},_applyFilterSearch:function(){var e=this._oTableFilterState.aSearch.concat(this._oTableFilterState.aFilter);this.getView().byId("lineItemsList").getBinding("items").filter(e,"Application")},changeUsers:function(e){var t=this.byId("viewSettingsDialogDetail").getFilterItems()[0].getCustomControl();var i=this.byId("viewSettingsDialogDetail").getFilterItems()[0];var s=t.getContent()[1].getValue();var a=t.getContent()[3].getValue();if(s==""&&a==""){i.setFilterCount(0);i.setSelected(false)}else{i.setFilterCount(1);i.setSelected(true)}},changeLast:function(e){var t=this.byId("viewSettingsDialogDetail").getFilterItems()[1].getCustomControl();var i=this.byId("viewSettingsDialogDetail").getFilterItems()[1];var s=t.getContent()[1].getValue();var a=t.getContent()[3].getValue();if(s==""&&a==""){i.setFilterCount(0);i.setSelected(false)}else{i.setFilterCount(1);i.setSelected(true)}},_applySortGroup:function(e,t){var i,s,a=[];i=e.getKey();s=t;a.push(new o(i,s));var r=this.getView().byId("lineItemsList").getBinding("items");r.sort(a)},_onMetadataLoaded:function(){var e=this.getView().getBusyIndicatorDelay(),t=this.getModel("detailView"),i=this.byId("lineItemsList"),s=i.getBusyIndicatorDelay();t.setProperty("/delay",0);t.setProperty("/lineItemTableDelay",0);i.attachEventOnce("updateFinished",function(){t.setProperty("/lineItemTableDelay",s)});t.setProperty("/busy",true);t.setProperty("/delay",e)},onCloseDetailPress:function(){this.getModel("appView").setProperty("/actionButtonsInfo/midColumn/fullScreen",false);this.getOwnerComponent().oListSelector.clearMasterListSelection();this.getRouter().navTo("master")},toggleFullScreen:function(){var e=this.getModel("appView").getProperty("/actionButtonsInfo/midColumn/fullScreen");this.getModel("appView").setProperty("/actionButtonsInfo/midColumn/fullScreen",!e);if(!e){this.getModel("appView").setProperty("/previousLayout",this.getModel("appView").getProperty("/layout"));this.getModel("appView").setProperty("/layout","MidColumnFullScreen")}else{this.getModel("appView").setProperty("/layout",this.getModel("appView").getProperty("/previousLayout"))}},handleCancel:function(){var e=this.byId("viewSettingsDialogDetail").getFilterItems()[0].getCustomControl();var t=this.byId("viewSettingsDialogDetail").getFilterItems()[0],i=e.getContent()[1],s=e.getContent()[3];i.setValue(this.fromUserPreviousValue);s.setValue(this.toUserPreviousValue);if(this.fromUserPreviousValue!==""||this.toUserPreviousValue!==""){t.setFilterCount(1);t.setSelected(true)}else{t.setFilterCount(0);t.setSelected(false)}var a=this.byId("viewSettingsDialogDetail").getFilterItems()[1].getCustomControl();var r=this.byId("viewSettingsDialogDetail").getFilterItems()[1],n=a.getContent()[1],o=a.getContent()[3];n.setValue(this.fromLastPreviousValue);o.setValue(this.toLastPreviousValue);if(this.fromLastPreviousValue!==""||this.toLastPreviousValue!==""){r.setFilterCount(1);r.setSelected(true)}else{r.setFilterCount(0);r.setSelected(false)}},handleResetFilters:function(){var e=this.byId("viewSettingsDialogDetail").getFilterItems()[0].getCustomControl();var t=this.byId("viewSettingsDialogDetail").getFilterItems()[0],i=e.getContent()[1],s=e.getContent()[3];i.setValue("");s.setValue("");t.setFilterCount(0);t.setSelected(false);var a=this.byId("viewSettingsDialogDetail").getFilterItems()[1].getCustomControl();var r=this.byId("viewSettingsDialogDetail").getFilterItems()[1],n=a.getContent()[1],o=a.getContent()[3];n.setValue("");o.setValue("");r.setFilterCount(0);r.setSelected(false)}})});