sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","./json2xml"],function(e,t,a){"use strict";return e.extend("shapein.ConfiguringUsers.controller.Configuration",{onInit:function(){var e=this;var t=this.getOwnerComponent().getModel();this.getView().setModel(t,"Base64");t.attachBatchRequestCompleted(function(a){var r=a.getParameter("requests");for(var o=0;o<r.length;o++){if(r[o].url=="Subscription_Settings"){e.readBase64(t)}}})},booleanTrans:function(e){if(e==="True"){return true}else{return false}},booleanTransOp:function(e){if(e==="True"){return false}else{return true}},addRow_email:function(e){var t=this.getView().getModel("ModelJSON");if(t.oData.global_configuration.mappings.email.filters.filter.length==undefined){t.oData.global_configuration.mappings.email.filters.filter=[{usage_public:"",type_data_primary:"",type_reference:"",_secuence:""}]}else{t.oData.global_configuration.mappings.email.filters.filter.push({usage_public:"",type_data_primary:"",type_reference:"",_secuence:""})}this.getView().getModel("ModelJSON").refresh()},deleteRow_email:function(e){var t=this.getView().getModel("ModelJSON");var a=this.getView().byId("table0_1603812787387");var r=a.getSelectedItems();if(r.length!=0){for(var o=0;o<r.length;o++){var l=r[o];var i=l.oBindingContexts.ModelJSON.getProperty();for(var s=0;s<t.oData.global_configuration.mappings.email.filters.filter.length;s++){if(t.oData.global_configuration.mappings.email.filters.filter[s]==i){t.oData.global_configuration.mappings.email.filters.filter.splice(s,1);this.getView().getModel("ModelJSON").refresh()}}}}else{sap.m.MessageToast.show("Please, select a row to delete.")}},addRow_trans:function(e){var t=this.getView().getModel("ModelJSON");if(t.oData.global_configuration.transformations.organization_code.transformation.length==undefined){t.oData.global_configuration.transformations.organization_code.transformation=[{characters:" ",separator:" ",replace_by:" ",_secuence:null}]}else{t.oData.global_configuration.transformations.organization_code.transformation.push({characters:" ",separator:" ",replace_by:" ",_secuence:null})}this.getView().getModel("ModelJSON").refresh()},deleteRow_trans:function(e){var t=this.getView().getModel("ModelJSON");var a=this.getView().byId("table1");var r=a.getSelectedItems();if(r.length!=0){for(var o=0;o<r.length;o++){var l=r[o];var i=l.oBindingContexts.ModelJSON.getProperty();for(var s=0;s<t.oData.global_configuration.transformations.organization_code.transformation.length;s++){if(t.oData.global_configuration.transformations.organization_code.transformation[s]==i){t.oData.global_configuration.transformations.organization_code.transformation.splice(s,1);this.getView().getModel("ModelJSON").refresh()}}}}else{sap.m.MessageToast.show("Please, select a row to delete.")}},addRow_roles:function(e){var t=this.getView().getModel("ModelJSON");if(t.getData().global_configuration.mappings.roles.pd_role.length===undefined){t.getData().global_configuration.mappings.roles.pd_role=[{_wd_role:" "}]}else{t.getData().global_configuration.mappings.roles.pd_role.push({_wd_role:" "})}this.getView().getModel("ModelJSON").refresh()},deleteRow_roles:function(e){var t=this.getView().getModel("ModelJSON");var a=this.getView().byId("table0");var r=a.getSelectedItems();if(r.length!==0){for(var o=0;o<r.length;o++){var l=r[o];var i=l.oBindingContexts.ModelJSON.getProperty();for(var s=0;s<t.getData().global_configuration.mappings.roles.pd_role.length;s++){if(t.getData().global_configuration.mappings.roles.pd_role[s]===i){t.getData().global_configuration.mappings.roles.pd_role.splice(s,1);this.getView().getModel("ModelJSON").refresh()}}}}else{sap.m.MessageToast.show("Please, select a row to delete.")}},readBase64:function(e){var t=this;var a="/Configurations";var r="/Pd_Languages";var o=new sap.ui.model.Filter("pck_code",sap.ui.model.FilterOperator.EQ,"SYN_USER");e.read(a,{filters:[o],success:function(e,a){var r;if(e.results.length!==0){var o=t._convertBase64toXML(e.results[0].value);var l=$.parseXML(o);r=t.transformXML2JSON(l)}else{r=t.createJSON()}var i=t.getJsonModel(r);t.getView().setModel(i,"ModelJSON");t.callCPIShapeIn_Language()}});e.read(r)},_convertBase64toXML:function(e){var t=window.atob(e);return t},transformXML2JSON:function(e){var t=this.createJSON();var a=e.childNodes;var r=a[0].childNodes;var o=r[0].childNodes;var l=o[0].childNodes;var i=l[0].childNodes;var s=i[0].childNodes[0].textContent;var n=i[1].childNodes[0].textContent;var g=i[2].childNodes[0].textContent;var d=i[3].childNodes;if(d[0].childNodes.length!==0){var c=d[0].childNodes[0].textContent}if(d[1].childNodes.length!==0){var u=d[1].childNodes[0].textContent}t.global_configuration.global_parameters.ws_get_workers.request_filter.exclude_contingent_workers=s;t.global_configuration.global_parameters.ws_get_workers.request_filter.exclude_employees=n;t.global_configuration.global_parameters.ws_get_workers.request_filter.exclude_inactive_workers=g;t.global_configuration.global_parameters.ws_get_workers.request_filter.custom_id.object_name=c;t.global_configuration.global_parameters.ws_get_workers.request_filter.custom_id.object_value=u;var f=r[1].childNodes;var _=f[0].childNodes;var p=_[0].childNodes;if(p.length!==0){if(p[0].childNodes.length!=0){var v=p[0].childNodes[0].textContent;t.global_configuration.mappings.language.default_values.BPC7_default_code=v}else{t.global_configuration.mappings.language.default_values.BPC7_default_code=""}}var h=f[1].childNodes;var m=h[0].childNodes;for(var b=0;b<m.length;b++){var w=m[b].childNodes;if(w.length!=0){var N=m[b].getAttribute("secuence")*1;if(w[0].childNodes.length!==0){var y=w[0].childNodes[0].textContent}else{y=" "}if(w[1]!==undefined){var C=w[1].childNodes[0].textContent}else{C=" "}if(w[2]!==undefined){var M=w[2].childNodes[0].textContent}else{M=" "}t.global_configuration.mappings.email.filters.filter.push({usage_public:y,type_data_primary:C,type_reference:M,_secuence:N})}}var S=f[2].childNodes;for(var x=0;x<S.length;x++){if(S[x].attributes.length!==0){var O=S[x].attributes[0].value;var P=S[x].textContent;t.global_configuration.mappings.roles.pd_role.push({_wd_role:O,text:P})}}var V=r[2].childNodes;var I=V[0].childNodes;for(var J=0;J<I.length;J++){var D=I[J].childNodes;if(D.length!==0){if(D[0].childNodes.length!==0){var k=D[0].childNodes[0].textContent}else{k=" "}if(D[1].childNodes.length!==0){var T=D[1].childNodes[0].textContent}else{T=" "}if(D[2].childNodes.length!==0){var B=D[2].childNodes[0].textContent}else{B=" "}}t.global_configuration.transformations.organization_code.transformation.push({characters:k,separator:T,replace_by:B})}return t},createJSON:function(){var e={global_configuration:{global_parameters:{ws_get_workers:{request_filter:{exclude_contingent_workers:"False",exclude_employees:"False",exclude_inactive_workers:"False",custom_id:{object_name:"",object_value:""}}}},mappings:{language:{default_values:{BPC7_default_code:" "}},email:{filters:{filter:[]}},roles:{pd_role:[]}},transformations:{organization_code:{transformation:[]}}}};return e},saveConfiguration:function(e){var t=[];var a=this.validation2Save();if(a){t=this.getUpdatedArray();var r=this.transformToBase64(t);var o=this.getView().getModel("Base64");var l={value:r};var i="/Configurations(pck_code='SYN_USER',conf_code='SCE-CONFIG')";o.update(i,l,{success:function(e,t){sap.m.MessageToast.show("Users Configurations updated.")},error:function(e,t){sap.m.MessageToast.show("Data can not be updated. Please try again")}})}else{sap.m.MessageToast.show("There is a field with wrong value.")}},validation2Save:function(){var e=true;return e},getUpdatedArray:function(){var e=this.createJSON();var t;var a;var r;var o;var l;if(this.getView().byId("rb001").getProperty("selected")){t="True"}else{t="False"}if(this.getView().byId("rb003").getProperty("selected")){a="True"}else{a="False"}if(this.getView().byId("rb005").getProperty("selected")){r="True"}else{r="False"}o=this.getView().byId("input0").getProperty("value");l=this.getView().byId("input1").getProperty("value");e.global_configuration.global_parameters.ws_get_workers.request_filter.exclude_contingent_workers=t;e.global_configuration.global_parameters.ws_get_workers.request_filter.exclude_employees=a;e.global_configuration.global_parameters.ws_get_workers.request_filter.exclude_inactive_workers=r;e.global_configuration.global_parameters.ws_get_workers.request_filter.custom_id.object_name=o;e.global_configuration.global_parameters.ws_get_workers.request_filter.custom_id.object_value=l;var i=this.getView().byId("table0_1603812787387").getItems();for(var s=0;s<i.length;s++){var n=i[s].getAggregation("cells");var g=n[0].getProperty("selectedKey");var d=n[1].getProperty("selectedKey");var c=n[2].getProperty("selectedKey");var u=n[3].getProperty("value").replace("_"," ")*1;e.global_configuration.mappings.email.filters.filter.push({usage_public:g,type_data_primary:d,type_reference:c,_secuence:u})}var f=this.getView().byId("table0").getItems();for(var _=0;_<f.length;_++){var p=f[_].getAggregation("cells");var v=p[0].getProperty("value");var h=p[1].getProperty("value");e.global_configuration.mappings.roles.pd_role.push({_wd_role:v});e.global_configuration.mappings.roles.pd_role[_]["#text"]=h}for(var m=0;m<e.global_configuration.mappings.roles.pd_role.length;m++){var b=e.global_configuration.mappings.roles.pd_role[m]["#text"].replace(/\s/g,"").length;if(b==0){e.global_configuration.mappings.roles.pd_role.splice(m,1)}}var w;w=this.getView().byId("combo01").getSelectedKey();e.global_configuration.mappings.language.default_values.BPC7_default_code=w;var N=this.getView().byId("table1").getItems();for(var y=0;y<N.length;y++){var C=N[y].getAggregation("cells");var M=C[0].getProperty("value");var S=C[1].getProperty("value");var x=C[2].getProperty("value");e.global_configuration.transformations.organization_code.transformation.push({characters:M,separator:S,replace_by:x})}return e},transformToBase64:function(e){var t;var a=$.json2xml(e);var r=a.split("<roles>");r=r[0];var o=a.substring(a.indexOf("<roles>"));var o=o.substring(0,o.indexOf("</roles>")+8);var l="";o=o.split("<#text>");for(var i=0;i<o.length;i++){l=l+o[i]}o=l;var s="";o=o.split("</#text>");for(var n=0;n<o.length;n++){s=s+o[n]}o=s;var g=a.split("</roles>");g=g[1];a=r+o+g;var t=window.btoa(a);return t},getJsonModel:function(e){var a=new t;a.oData=e;return a},callCPIShapeIn_Language:function(){var e="/CPI-WD2PD_Dest/md/peopledoc/client";var a=this;if(this.getOwnerComponent().settings){var r=this.getOwnerComponent().settings.find(e=>e.code==="Customer-Code");var o=this.getOwnerComponent().settings.find(e=>e.code==="Customer-Client_Id");var l=this.getOwnerComponent().settings.find(e=>e.code==="Customer-Scope");jQuery.ajax({url:e,beforeSend:function(e){e.setRequestHeader("Customer-Code",r.value);e.setRequestHeader("Customer-Client_Id",o.value);e.setRequestHeader("Customer-Scope",l.value)},type:"GET",dataType:"json",success:function(e){var r=a.getView().getModel("Base64").getProperty("/");var o=new t;var l=[];var i=e.available_languages;for(var s=0;s<i.length;s++){var n="Pd_Languages('"+i[s]+"')";l.push({code:r[n].code,text:r[n].text})}o.setData(l);a.getView().setModel(o,"Language")},error:function(e){}})}}})});