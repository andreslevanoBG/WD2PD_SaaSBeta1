sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","sap/ui/core/routing/History","sap/ui/model/Filter","sap/ui/model/Sorter","sap/ui/model/FilterOperator","sap/m/GroupHeaderListItem","sap/ui/Device","sap/ui/core/Fragment","../model/formatter"],function(e,t,a,r,n,i,o,s,l,u){"use strict";var g=sap.ui.core.format.DateFormat.getDateInstance({pattern:"YYYY-MM-ddTHH:mm:ss"});return e.extend("shapein.RunIntegrationPlanningWorkers.controller.Master",{formatter:u,onInit:function(){var e=this.byId("list"),a=this._createViewModel(),r=e.getBusyIndicatorDelay();this._oList=e;this._oListFilterState={aFilter:[],aSearch:[]};var n=sap.ui.getCore().getEventBus();n.subscribe("Detail","Delete_Plan",this._delete_Plan,this);this.setModel(a,"masterView");e.attachEventOnce("updateFinished",function(){a.setProperty("/delay",r)});this.getView().addEventDelegate({onBeforeFirstShow:function(){this.getOwnerComponent().oListSelector.setBoundMasterList(e)}.bind(this)});this.getRouter().getRoute("master").attachPatternMatched(this._onMasterMatched,this);this.getRouter().attachBypassed(this.onBypassed,this);this.setModel(new t,"newExec");var i={fromUpd:new Date(1900,0,1),toUpd:new Date,fromEffec:new Date(1900,0),toEffec:new Date,workers:[],supervisories:[]};var o=this.getView().getModel("newExec");o.setData(i);var s=this.getOwnerComponent().getModel("timezones");s.setSizeLimit(1e3)},onUpdateFinished:function(e){this._updateListItemCount(e.getParameter("total"))},onSearch:function(e){if(e.getParameters().refreshButtonPressed){this.onRefresh();return}this._oListFilterState.aFilter=[new r("pck_code",i.EQ,"SYN_WORKER")];var t=e.getParameter("query");if(t){this._oListFilterState.aSearch=[new r("comments",i.Contains,t)]}else{this._oListFilterState.aSearch=[]}this._applyFilterSearch()},_delete_Plan:function(e,t,a){if(t==="Delete_Plan"){var r=a.Number;var n=this._oList.getItems();var i=this.getOwnerComponent().getModel();for(var o=0;o<n.length;o++){var s=n[o].getTitle();if(s!==r){var l=n[o];this._oList.setSelectedItem(l,true);var u={listItem:l,selected:true};var g=l.getBindingContext().getPath();this.getOwnerComponent().oListSelector.selectAListItem(g);this._oList.fireSelectionChange(u);break}}}},onRefresh:function(){this._oList.getBinding("items").refresh()},onOpenViewSettings:function(e){var t="filter";if(e.getSource()instanceof sap.m.Button){var a=e.getSource().getId();if(a.match("sort")){t="sort"}else if(a.match("group")){t="group"}}if(!this.byId("viewSettingsDialog")){l.load({id:this.getView().getId(),name:"shapein.RunIntegrationPlanningWorkers.view.ViewSettingsDialog",controller:this}).then(function(e){this.getView().addDependent(e);e.addStyleClass(this.getOwnerComponent().getContentDensityClass());e.open(t)}.bind(this))}else{this.byId("viewSettingsDialog").open(t)}},onConfirmViewSettingsDialog:function(e){this._applySortGroup(e)},_applySortGroup:function(e){var t=e.getParameters(),a,r,i=[];a=t.sortItem.getKey();r=t.sortDescending;i.push(new n(a,r));this._oList.getBinding("items").sort(i)},onSelectionChange:function(e){var t=e.getSource(),a=e.getParameter("selected");if(!(t.getMode()==="MultiSelect"&&!a)){this._showDetail(e.getParameter("listItem")||e.getSource())}},onBypassed:function(){this._oList.removeSelections(true)},createGroupHeader:function(e){return new o({title:e.text,upperCase:false})},onNavBack:function(){var e=a.getInstance().getPreviousHash(),t=sap.ushell.Container.getService("CrossApplicationNavigation");if(e!==undefined||!t.isInitialNavigation()){history.go(-1)}else{t.toExternal({target:{shellHash:"#Shell-home"}})}},_createViewModel:function(){return new t({isFilterBarVisible:false,filterBarLabel:"",delay:0,title:this.getResourceBundle().getText("masterTitleCount",[0]),noDataText:this.getResourceBundle().getText("masterListNoDataText"),sortBy:"uuid",groupBy:"None"})},_onMasterMatched:function(){this.getModel("appView").setProperty("/layout","OneColumn")},_showDetail:function(e){var t=!s.system.phone;this.getModel("appView").setProperty("/layout","TwoColumnsMidExpanded");this.getRouter().navTo("object",{objectId:e.getBindingContext().getProperty("uuid")},t)},_updateListItemCount:function(e){var t;if(this._oList.getBinding("items").isLengthFinal()){t=this.getResourceBundle().getText("masterTitleCount",[e]);this.getModel("masterView").setProperty("/title",t)}},_applyFilterSearch:function(){var e=this._oListFilterState.aSearch.concat(this._oListFilterState.aFilter),t=this.getModel("masterView");this._oList.getBinding("items").filter(e,"Application");if(e.length!==0){t.setProperty("/noDataText",this.getResourceBundle().getText("masterListNoDataWithFilterOrSearchText"))}else if(this._oListFilterState.aSearch.length>0){t.setProperty("/noDataText",this.getResourceBundle().getText("masterListNoDataText"))}},_updateFilterBar:function(e){var t=this.getModel("masterView");t.setProperty("/isFilterBarVisible",this._oListFilterState.aFilter.length>0);t.setProperty("/filterBarLabel",this.getResourceBundle().getText("masterFilterBarText",[e]))},cancelOnDemand:function(e){var t=e.getSource().getParent();t.close()},_validateInput:function(e){var t="None";var a=false;var r=e.getValue();if(r==""){t="Error";a=true}e.setValueState(t);return a},changeDatesDemand:function(e){var t=e.getParameter("value");var a=e.getSource();var r="None";if(t==""){r="Error"}else{}a.setValueState(r)},execOnDemand:function(e){var t=this.getView(),a=[t.byId("DTP11"),t.byId("DTP12"),t.byId("DTP13"),t.byId("DTP14")],r=false;a.forEach(function(e){r=this._validateInput(e)||r},this);if(r){sap.m.MessageBox.alert("A validation error has occurred.");return}if(a[0].getDateValue()>a[1].getDateValue()){sap.m.MessageBox.alert("Date 'Updated To' is earlier than 'Updated From'.");a[1].setValueState("Error");return}if(a[2].getDateValue()>a[3].getDateValue()){sap.m.MessageBox.alert("Date 'Effective To' is earlier than 'Effective From'.");a[1].setValueState("Error");return}var n="Are you sure you want to execute this integration on Demand?";var i=this;var o=e.getSource().getParent();var s=new sap.m.Dialog({title:"Confirmation",type:"Message",content:new sap.m.Text({text:n}),beginButton:new sap.m.Button({text:"Yes",press:function(){var e=i.getModel("newExec");var t=e.getProperty("/fromUpd");var a=e.getProperty("/toUpd");var r=e.getProperty("/fromEffec");var n=e.getProperty("/toEffec");var l=i.byId("multiInput1").getTokens();var u=i.byId("multiInput2").getTokens();var c=[];var d=[];var p=i.byId("RefIdWorkers").getSelectedKey();for(var h=0;h<l.length;h++){var v=l[h].getText();c.push(v)}for(var h=0;h<u.length;h++){var f=u[h].getText();d.push(f)}t=g.format(t);a=g.format(a);r=g.format(r);n=g.format(n);var m={test_mode:"False",transaction_log:{time_zone:"CET",updated_from:t,updated_to:a,effective_from:r,effective_to:n},supervisories:{reference_id:"Organization_Reference_ID",supervisories_list:[c]},workers:{reference_id:p,workers_list:d}};var y=JSON.stringify(m);var _="/CPI-WD2PD_Dest/md/workers_sync/ondemand";if(i.getOwnerComponent().settings){var I=i.getOwnerComponent().settings.find(e=>e.code==="Customer-Code");var w=i.getOwnerComponent().settings.find(e=>e.code==="Customer-Client_Id");var S=i.getOwnerComponent().settings.find(e=>e.code==="Customer-Scope");var D={url:_,method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","Customer-Code":I.value,"Customer-Client_Id":w.value,"Customer-Scope":S.value},data:y};$.ajax(D).done(function(e,t,a){var r=e;var n=t;var i=a;if(t=="success"){var o="Execution On Demand "+e.uuid_exec+" executed.";sap.m.MessageToast.show(o)}}).fail(function(e,t,a){var r=e;var n=t;var i=a})}s.close();o.close()}}),endButton:new sap.m.Button({text:"No",press:function(){s.close()}}),afterClose:function(){s.destroy()}});s.open()},createPlan:function(e){if(!this.byId("newPlan")){l.load({id:this.getView().getId(),name:"shapein.RunIntegrationPlanningWorkers.view.fragment.NewPlanning",controller:this}).then(function(e){this.getView().addDependent(e);e.addStyleClass(this.getOwnerComponent().getContentDensityClass());var t=function(e){var t=e.text;return new sap.m.Token({key:t,text:t})};this.getView().byId("multiInput11").addValidator(t);e.open()}.bind(this))}else{this.byId("newPlan").open()}},_validateInputNewP:function(e){var t="None";var a=false;var r=e.getBinding("value");var n=e.getValue();if(n==""){t="Error";a=true}e.setValueState(t);return a},execNewPlan:function(e){var t=this.getView(),a=[t.byId("Comments"),t.byId("DTP1"),t.byId("DTP2"),t.byId("DTP3")],r=false;if(this.byId("ProcessType").getSelectedKey()==="I"){a.forEach(function(e){r=this._validateInputNewP(e)||r},this)}if(r){sap.m.MessageBox.alert("A validation error has occurred.");return}var n=a[0].getValue();var i="Are you sure you want to create a Workers Planning?";var o=this;var s=e.getSource().getParent();var l=new sap.m.Dialog({title:"Confirmation",type:"Message",content:new sap.m.Text({text:i}),beginButton:new sap.m.Button({text:"Yes",press:function(){var e=o.byId("SegBut").getSelectedKey();var t=false;if(e=="A"){t=true}var a=o.byId("ProcessType").getSelectedKey();var r={pck_code:"SYN_WORKER",type:"D",enable:t,processing_type:a,comments:n};var i=o.getOwnerComponent().getModel();s.setBusy(true);i.create("/Integration_Pck_Planning",r,{headers:{"Content-Type":"application/json",Accept:"application/json"},success:function(e,t){s.setBusy(false);s.close();o.createDataBatch(e.uuid,e.processing_type);sap.m.MessageToast.show("Planning created succesfully.")},error:function(e){s.setBusy(false);s.close();sap.m.MessageToast.show("Error")}});l.close()}}),endButton:new sap.m.Button({text:"No",press:function(){l.close()}}),afterClose:function(){l.destroy()}});l.open()},createDataBatch:function(e,t){var a=e;var r="/Integration_Pck_Planning_Adata";var n=this.getOwnerComponent().getModel();n.setDeferredGroups(["createGroup"]);var i={};if(t=="I"){i.planning_uuid=a;i.level1="WS_GET_WORKERS";i.level2="TIME_ZONE";i.value=this.byId("TimeZone").getSelectedKey();i.value2=null;n.create(r,i,{groupId:"createGroup"});var o={};o.planning_uuid=a;o.level1="WS_GET_WORKERS";o.level2="NEXT_UPDATED_FROM";o.value="";o.value2=null;n.create(r,o,{groupId:"createGroup"});var s={};s.planning_uuid=a;s.level1="WS_GET_WORKERS";s.level2="INITIAL_DATE_FROM";s.value=this.byId("DTP1").getValue();s.value2=null;n.create(r,s,{groupId:"createGroup"});var l={};l.planning_uuid=a;l.level1="WS_GET_WORKERS";l.level2="RETRO_CHG_EFFECTIVE_FROM";l.value=this.byId("DTP2").getValue();l.value2=null;n.create(r,l,{groupId:"createGroup"});var u={};u.planning_uuid=a;u.level1="WS_GET_WORKERS";u.level2="FUTURE_CHG_UPDATED_FROM";u.value=this.byId("DTP3").getValue();u.value2=null;n.create(r,u,{groupId:"createGroup"})}var g={};g.planning_uuid=a;g.level1="SUPERVISORIES_ALLOWED";g.level2="REFERENCE_ID";g.value=this.byId("RefId").getSelectedKey();g.value2=null;n.create(r,g,{groupId:"createGroup"});var c=this.byId("multiInput11").getTokens();for(var d=0;d<c.length;d++){var p={};p.planning_uuid=a;p.level1="SUPERVISORIES_ALLOWED";p.level2="SUPERVISORY";p.value=c[d].getText();p.value2=null;n.create(r,p,{groupId:"createGroup"})}n.submitChanges({groupId:"createGroup",success:this.successCreateBatch,error:this.errorCreateBatch})},successCreateBatch:function(e,t){var a=0},errorCreateBatch:function(e){var t=0},cancelNewPlan:function(e){var t=e.getSource().getParent();t.close()},changeTypeProcessing:function(e){var t=e.getParameter("selectedItem").getKey();var a=this.getView();var r=a.byId("SimpleFormChange480_12");if(t=="R"){r.getAggregation("form").getAggregation("formContainers")[1].setVisible(false)}else{r.getAggregation("form").getAggregation("formContainers")[1].setVisible(true)}},newOnDemand:function(e){if(!this.byId("ondemand")){l.load({id:this.getView().getId(),name:"shapein.RunIntegrationPlanningWorkers.view.fragment.OnDemand",controller:this}).then(function(e){this.getView().addDependent(e);e.addStyleClass(this.getOwnerComponent().getContentDensityClass());var t=function(e){var t=e.text;return new sap.m.Token({key:t,text:t})};this.getView().byId("multiInput1").addValidator(t);this.getView().byId("multiInput2").addValidator(t);e.open()}.bind(this))}else{this.byId("ondemand").open()}}})});